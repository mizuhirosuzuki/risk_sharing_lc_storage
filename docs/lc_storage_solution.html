<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.280">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Risk-sharing with limited commitment and storage - 2&nbsp; Risk sharing with limited commitment and storage: Numerical solution</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./lc_storage_simulation.html" rel="next">
<link href="./lc_storage_model.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script>window.backupDefine = window.define; window.define = undefined;</script><script src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js"></script>
  <script>document.addEventListener("DOMContentLoaded", function () {
 var mathElements = document.getElementsByClassName("math");
 var macros = [];
 for (var i = 0; i < mathElements.length; i++) {
  var texText = mathElements[i].firstChild;
  if (mathElements[i].tagName == "SPAN") {
   katex.render(texText.data, mathElements[i], {
    displayMode: mathElements[i].classList.contains('display'),
    throwOnError: false,
    macros: macros,
    fleqn: false
   });
}}});
  </script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css">

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Risk sharing with limited commitment and storage: Numerical solution</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Risk-sharing with limited commitment and storage</a> 
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Preface</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lc_storage_model.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Risk sharing with limited commitment and storage: Model</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lc_storage_solution.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Risk sharing with limited commitment and storage: Numerical solution</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lc_storage_simulation.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Risk sharing with limited commitment and storage: Simulation</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lc_no_storage.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Comparison: Risk sharing with limited commitment but without storage</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#steps-for-solving-the-model" id="toc-steps-for-solving-the-model" class="nav-link active" data-scroll-target="#steps-for-solving-the-model"><span class="toc-section-number">2.1</span>  Steps for solving the model</a></li>
  <li><a href="#numerical-solutions" id="toc-numerical-solutions" class="nav-link" data-scroll-target="#numerical-solutions"><span class="toc-section-number">2.2</span>  Numerical solutions</a>
  <ul class="collapse">
  <li><a href="#global-settings" id="toc-global-settings" class="nav-link" data-scroll-target="#global-settings"><span class="toc-section-number">2.2.1</span>  Global settings</a></li>
  <li><a href="#value-at-autarky-with-private-storage" id="toc-value-at-autarky-with-private-storage" class="nav-link" data-scroll-target="#value-at-autarky-with-private-storage"><span class="toc-section-number">2.2.2</span>  Value at autarky with private storage</a></li>
  <li><a href="#model-with-storage-and-limited-commitment" id="toc-model-with-storage-and-limited-commitment" class="nav-link" data-scroll-target="#model-with-storage-and-limited-commitment"><span class="toc-section-number">2.2.3</span>  Model with storage and limited commitment</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Risk sharing with limited commitment and storage: Numerical solution</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>Next, I explain the procedure for solving the model numerically and actually solve it. Since it took around 10 hours to solve the model just for one interest rate, which is partly because my R script does not use the symmetry of the states as in <span class="citation" data-cites="abraham2018efficient">Ábrahám and Laczó (<a href="#ref-abraham2018efficient" role="doc-biblioref">2018</a>)</span>, I just solve the model once for one interest rate.</p>
<section id="steps-for-solving-the-model" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="steps-for-solving-the-model"><span class="header-section-number">2.1</span> Steps for solving the model</h2>
<p>Based on the modeling solution described in the previous page, I explain how to solve the model numerically. First, prepare <span class="math inline">V_1^0(y, B, x)</span>, <span class="math inline">V_2^0(y, B, x)</span>, <span class="math inline">\underline{x}^0(y, B)</span>, <span class="math inline">\overline{x}^0(y, B)</span>, and <span class="math inline">B'^0(y, B, x)</span>, and below I describe the steps in <span class="math inline">h</span>’th iteration. Note that the updating rule of relative Pareto weight, <span class="math inline">x'^h(y, B, x)</span> is determined by <span class="math inline">(\underline{x}^h(y, B), \overline{x}^h(y, B))</span>.</p>
<ol type="1">
<li>First, I update <span class="math inline">\overline{x}(y, B)</span>. For this, solve for <span class="math inline">\overline{x}(y, B)</span> in the equation below such that the household 1’s participation constraint binds with 0 next-period saving: <span class="math display">
  u(c_1(y, B, \overline{x}(y, B))) + \beta \sum_{y'} Pr(y') V_1^{h - 1}(y', 0, \overline{x}(y, B)) = U_1^{aut}(y),
</span> where <span class="math display">
  c_1(y, B, \overline{x}(y, B)) = \frac{y + (1 + r)B}{1 + \overline{x}(y, B)}.
</span> Then check if the planner’s Euler equation is satisfied at this <span class="math inline">\overline{x}(y, B)</span>, by seeing if the following expression is non-negative or not: <span class="math display">
  u'(c_1(y, B, \overline{x}(y, B))) - \beta (1 + r) \sum_{y'} Pr(y') \frac{u'(c_1(y', 0, \overline{x}(y, B)))}{1 - \nu_1(y', 0, \overline{x}(y, B))},
</span> where, <span class="math display">
\begin{aligned}
  c_1(y', 0, \overline{x}(y, B)) &amp;= \frac{y' - B'^{(h - 1)}(y', 0, \overline{x}(y, B))}{1 + x'^{(h - 1)}(y', 0, \overline{x}(y, B))} \\
  \nu_1(y', 0, \overline{x}(y, B)) &amp;= \min \left\{ 1 - \frac{x'^{(h - 1)}(y', 0, \overline{x}(y, B))}{\overline{x}(y, B)}, 1 \right\}.
\end{aligned}
</span> If this is non-negative, update <span class="math inline">B'^h(y, B, \overline{x}(y, B)) = 0</span> and <span class="math inline">\overline{x}^h(y, B) = \overline{x}(y, B)</span>. If this is negative, then since the planner’s Euler equation is violated with <span class="math inline">B' = 0</span>, I solve the following non-linear system of two equations for <span class="math inline">\overline{x}(y, B)</span> and <span class="math inline">B'</span>: <span class="math display">
\begin{aligned}
  &amp;u'(c_1(y, B, \overline{x}(y, B))) - \beta (1 + r) \sum_{y'} Pr(y') \frac{u'(c_1(y', B', \overline{x}(y, B)))}{1 - \nu_1(y', B', \overline{x}(y, B))} = 0 \\
  &amp;u(c_1(y, B, \overline{x}(y, B))) + \beta \sum_{y'} Pr(y') V_1^{h - 1}(y', B', \overline{x}(y, B)) = U_1^{aut}(y),
\end{aligned}
</span> and update <span class="math inline">B'^h(y, B, \overline{x}(y, B))</span> and <span class="math inline">\overline{x}^h(y, B)</span> with the solutions. The value functions are updated such that <span class="math display">
\begin{aligned}
  V_1^{h}(y, B, \overline{x}(y, B)) &amp;= U_1^{aut}(y) \\
  V_2^{h}(y, B, \overline{x}(y, B)) &amp;= u(c_2(y, B, \overline{x}(y, B))) + \beta \sum_{y'} Pr(y') V_2^{h - 1}(y', B'^h(y, B, \overline{x}(y, B)), \overline{x}(y, B)).
\end{aligned}
</span></li>
<li>Next, I update <span class="math inline">\underline{x}(y, B)</span> in a similar way. First solve for <span class="math inline">\underline{x}(y, B)</span> such that the household 2’s participation constraint binds with 0 next-period saving: <span class="math display">
  u(c_2(y, B, \underline{x}(y, B))) + \beta \sum_{y'} Pr(y') V_2^{h - 1}(y', 0, \underline{x}(y, B)) = U_2^{aut}(y),
</span> where <span class="math display">
  c_2(y, B, \underline{x}(y, B)) = \frac{y + (1 + r)B}{1 + 1 / \underline{x}(y, B)}.
</span> And I check if the planner’s Euler equation is satisfied at <span class="math inline">\overline{x}(y, B)</span> with <span class="math inline">B' = 0</span>, by checking if <span class="math display">
  u'(c_1(y, B, \underline{x}(y, B))) - \beta (1 + r) \sum_{y'} Pr(y') \frac{u'(c_1(y', 0, \underline{x}(y, B)))}{1 - \nu_1(y', 0, \underline{x}(y, B))} \ge 0
</span> or not. If this is the case, update <span class="math inline">B'^h(y, B, \underline{x}(y, B)) = 0</span> and <span class="math inline">\underline{x}^h(y, B) = \underline{x}(y, B)</span>. Otherwise, since the planner’s Euler equation is violated with <span class="math inline">B' = 0</span>, I solve the following non-linear system of two equations for <span class="math inline">B'</span> and <span class="math inline">\underline{x}(y, B)</span>: <span class="math display">
\begin{aligned}
  &amp;u'(c_1(y, B, \underline{x}(y, B))) - \beta (1 + r) \sum_{y'} Pr(y') \frac{u'(c_1(y', B', \underline{x}(y, B)))}{1 - \nu_1(y', B', \underline{x}(y, B))} = 0 \\
  &amp;u(c_2(y, B, \underline{x}(y, B))) + \beta \sum_{y'} Pr(y') V_2^{h - 1}(y', B', \underline{x}(y, B)) = U_2^{aut}(y),
\end{aligned}
</span> and update <span class="math inline">B'^h(y, B, \underline{x}(y, B))</span> and <span class="math inline">\underline{x}^h(y, B)</span> with the solutions. The value functions are updated such that <span class="math display">
\begin{aligned}
  V_1^{h}(y, B, \underline{x}(y, B)) &amp;= u(c_1(y, B, \underline{x}(y, B))) + \beta \sum_{y'} Pr(y') V_1^{h - 1}(y', B'^h(y, B, \underline{x}(y, B)), \underline{x}(y, B)) \\
  V_2^{h}(y, B, \underline{x}(y, B)) &amp;= U_2^{aut}(y).
\end{aligned}
</span></li>
<li>For <span class="math inline">x \in [\underline{x}(y, B), \overline{x}(y, B)]</span>, where no participation constraint binds, first check if <span class="math inline">B' = 0</span> satisfied the planner’s Euler equation: <span class="math display">
  u'(c_1(y, B, x)) \ge \beta (1 + r) \sum_{y'} Pr(y') \frac{u'(c_1(y', 0, x))}{1 - \nu_1(y', 0, x)}.
</span> If this is violated, I solve for <span class="math inline">B'</span> such that the planner’s Euler equation holds with equality: <span class="math display">
  u'(c_1(y, B, x)) = \beta (1 + r) \sum_{y'} Pr(y') \frac{u'(c_1(y', B', x))}{1 - \nu_1(y', B', x)}.
</span> Then update <span class="math inline">B'^h(y, B, x)</span> with the solution. The value functions are updated as follows: <span class="math display">
\begin{aligned}
  V_1^{h}(y, B, x) &amp;= u(c_1(y, B, x)) + \beta \sum_{y'} Pr(y') V_1^{h - 1}(y', B'^h(y, B, x), x) \\
  V_2^{h}(y, B, x) &amp;= u(c_1(y, B, x)) + \beta \sum_{y'} Pr(y') V_1^{h - 1}(y', B'^h(y, B, x), x).
\end{aligned}
</span></li>
<li>For <span class="math inline">x &lt; \underline{y, B}</span>, update the policy functions and value functions in the following way (remember that these do not depend on <span class="math inline">x</span>, as discussed in the modeling solution section above): <span class="math display">
\begin{aligned}
  V_1^{h}(y, B, x) &amp;= V_1^h(y, B, \underline{x}(y, B)) \\
  V_2^{h}(y, B, x) &amp;= U_2^{aut}(y) \\
  B^h(y, B, x) &amp;= B^h(y, B, \underline{x}(y, B)).
\end{aligned}
</span> Similarly, for <span class="math inline">x &gt; \overline{y, B}</span>, the policy functions and value functions are updated such that <span class="math display">
\begin{aligned}
  V_1^{h}(y, B, x) &amp;= U_1^{aut}(y) \\
  V_2^{h}(y, B, x) &amp;= V_2^h(y, B, \overline{x}(y, B)) \\
  B^h(y, B, x) &amp;= B^h(y, B, \overline{x}(y, B)).
\end{aligned}
</span></li>
</ol>
</section>
<section id="numerical-solutions" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="numerical-solutions"><span class="header-section-number">2.2</span> Numerical solutions</h2>
<section id="global-settings" class="level3" data-number="2.2.1">
<h3 data-number="2.2.1" class="anchored" data-anchor-id="global-settings"><span class="header-section-number">2.2.1</span> Global settings</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  tidyverse,</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  nleqslv,</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  pracma,</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  tictoc</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>numStates <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>numRelativeParetoWeights <span class="ot">&lt;-</span> <span class="dv">201</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>beta <span class="ot">&lt;-</span> <span class="fl">0.8</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>sigma <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>incomeGridPointsHH1 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.353</span>, <span class="fl">0.5</span>, <span class="fl">0.647</span>)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>incomeGridPointsHH2 <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> incomeGridPointsHH1</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>aggregateIncomeGridPoints <span class="ot">&lt;-</span> incomeGridPointsHH1 <span class="sc">+</span> incomeGridPointsHH2</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>incomeTransitionProbVec <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span> <span class="sc">/</span> <span class="dv">3</span>, <span class="dv">3</span>)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>incomeTransitionMatrix <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">1</span> <span class="sc">/</span> <span class="dv">3</span>, <span class="at">nrow =</span> <span class="dv">3</span>, <span class="at">ncol =</span> <span class="dv">3</span>)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>returnOnStorage <span class="ot">&lt;-</span> <span class="fl">0.02</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>calculateUtility <span class="ot">&lt;-</span> <span class="cf">function</span>(cons, sigma) {</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (sigma <span class="sc">!=</span> <span class="dv">1</span>) {</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    utility <span class="ot">=</span> (cons<span class="sc">^</span>(<span class="dv">1</span> <span class="sc">-</span> sigma) <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> sigma)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (sigma <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    utility <span class="ot">=</span> <span class="fu">log</span>(cons)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(utility)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>calculateMarginalUtility <span class="ot">&lt;-</span> <span class="cf">function</span>(cons, sigma) cons<span class="sc">^</span>(<span class="sc">-</span> sigma)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>createStorageGridPoints <span class="ot">&lt;-</span> <span class="cf">function</span>(incomeGridPointsHH1) {</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  storageGridPoints <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fu">sqrt</span>(<span class="fu">max</span>(incomeGridPointsHH1)), <span class="at">by =</span> <span class="fl">1e-2</span>)<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  numStorageGridPoints <span class="ot">&lt;-</span> <span class="fu">length</span>(storageGridPoints)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(storageGridPoints, numStorageGridPoints))</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>createRelativeParetoWeightGridPoints <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    returnOnStorage,</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    storageGridPoints,</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    incomeGridPointsHH1</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>) {</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  maxRelativeParetoWeight <span class="ot">&lt;-</span> (</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">1</span> <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">+</span> returnOnStorage) <span class="sc">*</span> <span class="fu">max</span>(storageGridPoints)) <span class="sc">/</span> <span class="fu">min</span>(incomeGridPointsHH1) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  minRelativeParetoWeight <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> maxRelativeParetoWeight</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  relativeParetoWeightsGridPoints <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">seq</span>(</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>      minRelativeParetoWeight, <span class="dv">1</span>,</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">by =</span> (<span class="dv">1</span> <span class="sc">-</span> minRelativeParetoWeight) <span class="sc">/</span> <span class="fu">floor</span>(numRelativeParetoWeights <span class="sc">/</span> <span class="dv">2</span>)</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rev</span>(<span class="dv">1</span> <span class="sc">/</span> <span class="fu">seq</span>(</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>      minRelativeParetoWeight, <span class="dv">1</span>,</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">by =</span> (<span class="dv">1</span> <span class="sc">-</span> minRelativeParetoWeight) <span class="sc">/</span> <span class="fu">floor</span>(numRelativeParetoWeights <span class="sc">/</span> <span class="dv">2</span>)</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    )[<span class="dv">1</span><span class="sc">:</span><span class="fu">floor</span>(numRelativeParetoWeights <span class="sc">/</span> <span class="dv">2</span>)])</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(relativeParetoWeightsGridPoints)</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="value-at-autarky-with-private-storage" class="level3" data-number="2.2.2">
<h3 data-number="2.2.2" class="anchored" data-anchor-id="value-at-autarky-with-private-storage"><span class="header-section-number">2.2.2</span> Value at autarky with private storage</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>calculateEulerEquationDiffAutarky <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    consumption,</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    income,</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    storage,</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    beta,</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    sigma,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    returnOnStorage,</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    incomeProb,</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    storageGridPoints,</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    consumptionAutarkyMatrix</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>) {</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>  interpolatedConsumptionByIncome <span class="ot">&lt;-</span> <span class="fu">apply</span>(</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    consumptionAutarkyMatrix,</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span>,</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(x) {</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>      <span class="fu">approx</span>(</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>        storageGridPoints,</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>        x,</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>        income <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">+</span> returnOnStorage) <span class="sc">*</span> storage <span class="sc">-</span> consumption,</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>        <span class="at">rule =</span> <span class="dv">2</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>      )<span class="sc">$</span>y}</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">calculateMarginalUtility</span>(consumption, sigma) <span class="sc">-</span> (</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>      beta <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> returnOnStorage) <span class="sc">*</span> (</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>        incomeProb <span class="sc">%*%</span> <span class="fu">calculateMarginalUtility</span>(interpolatedConsumptionByIncome, sigma)</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>interpolateValueByIncome <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>    consumption,</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>    income,</span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>    storage,</span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>    valueAutarkyMatrix,</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>    storageGridPoints,</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>    returnOnStorage</span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>) {</span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(</span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">apply</span>(</span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>      valueAutarkyMatrix,</span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>      <span class="dv">1</span>,</span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>      <span class="cf">function</span>(x) {</span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>        <span class="fu">approx</span>(</span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>          storageGridPoints,</span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>          x,</span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>          income <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">+</span> returnOnStorage) <span class="sc">*</span> storage <span class="sc">-</span> consumption,</span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>          <span class="at">rule =</span> <span class="dv">2</span></span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>          )<span class="sc">$</span>y}</span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a>      )     </span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a>updateValueAutarky <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a>  consumption,</span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a>  interpolatedValueByIncome,</span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a>  incomeProb,</span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a>  beta,</span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a>  sigma</span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true" tabindex="-1"></a>) {</span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(</span>
<span id="cb6-65"><a href="#cb6-65" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb6-66"><a href="#cb6-66" aria-hidden="true" tabindex="-1"></a>      <span class="fu">calculateUtility</span>(consumption, sigma)</span>
<span id="cb6-67"><a href="#cb6-67" aria-hidden="true" tabindex="-1"></a>      <span class="sc">+</span> beta <span class="sc">*</span> (</span>
<span id="cb6-68"><a href="#cb6-68" aria-hidden="true" tabindex="-1"></a>        incomeProb <span class="sc">%*%</span> interpolatedValueByIncome</span>
<span id="cb6-69"><a href="#cb6-69" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb6-70"><a href="#cb6-70" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-71"><a href="#cb6-71" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb6-72"><a href="#cb6-72" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-73"><a href="#cb6-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-74"><a href="#cb6-74" aria-hidden="true" tabindex="-1"></a>computeConsumptionAutarky <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb6-75"><a href="#cb6-75" aria-hidden="true" tabindex="-1"></a>    returnOnStorage,</span>
<span id="cb6-76"><a href="#cb6-76" aria-hidden="true" tabindex="-1"></a>    storageGridPoints,</span>
<span id="cb6-77"><a href="#cb6-77" aria-hidden="true" tabindex="-1"></a>    incomeGridPoints,</span>
<span id="cb6-78"><a href="#cb6-78" aria-hidden="true" tabindex="-1"></a>    beta,</span>
<span id="cb6-79"><a href="#cb6-79" aria-hidden="true" tabindex="-1"></a>    sigma,</span>
<span id="cb6-80"><a href="#cb6-80" aria-hidden="true" tabindex="-1"></a>    incomeProb,</span>
<span id="cb6-81"><a href="#cb6-81" aria-hidden="true" tabindex="-1"></a>    numStates,</span>
<span id="cb6-82"><a href="#cb6-82" aria-hidden="true" tabindex="-1"></a>    numStorageGridPoints,</span>
<span id="cb6-83"><a href="#cb6-83" aria-hidden="true" tabindex="-1"></a>    <span class="at">iterationTol =</span> <span class="fl">1e-8</span>,</span>
<span id="cb6-84"><a href="#cb6-84" aria-hidden="true" tabindex="-1"></a>    <span class="at">maxIteration =</span> <span class="dv">100</span></span>
<span id="cb6-85"><a href="#cb6-85" aria-hidden="true" tabindex="-1"></a>) {</span>
<span id="cb6-86"><a href="#cb6-86" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-87"><a href="#cb6-87" aria-hidden="true" tabindex="-1"></a>  consumptionAutarkyMatrix <span class="ot">&lt;-</span> <span class="fu">outer</span>(<span class="fu">rep</span>(<span class="dv">1</span>, numStates), (<span class="dv">1</span> <span class="sc">/</span> beta <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> storageGridPoints) <span class="sc">+</span> <span class="fl">1e-8</span></span>
<span id="cb6-88"><a href="#cb6-88" aria-hidden="true" tabindex="-1"></a>  consumptionAutarkyMatrixNew <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> numStates, numStorageGridPoints)</span>
<span id="cb6-89"><a href="#cb6-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-90"><a href="#cb6-90" aria-hidden="true" tabindex="-1"></a>  iter <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb6-91"><a href="#cb6-91" aria-hidden="true" tabindex="-1"></a>  diff <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb6-92"><a href="#cb6-92" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> ((diff <span class="sc">&gt;</span> iterationTol) <span class="sc">&amp;</span> (iter <span class="sc">&lt;</span> maxIteration)) {</span>
<span id="cb6-93"><a href="#cb6-93" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-94"><a href="#cb6-94" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (stateIndex <span class="cf">in</span> <span class="fu">seq</span>(<span class="dv">1</span>, numStates)) {</span>
<span id="cb6-95"><a href="#cb6-95" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (storageIndex <span class="cf">in</span> <span class="fu">seq</span>(<span class="dv">1</span>, numStorageGridPoints)) {</span>
<span id="cb6-96"><a href="#cb6-96" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-97"><a href="#cb6-97" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">calculateEulerEquationDiffAutarky</span>(</span>
<span id="cb6-98"><a href="#cb6-98" aria-hidden="true" tabindex="-1"></a>            storageGridPoints[storageIndex] <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> returnOnStorage) <span class="sc">+</span> incomeGridPoints[stateIndex],</span>
<span id="cb6-99"><a href="#cb6-99" aria-hidden="true" tabindex="-1"></a>            incomeGridPoints[stateIndex],</span>
<span id="cb6-100"><a href="#cb6-100" aria-hidden="true" tabindex="-1"></a>            storageGridPoints[storageIndex],</span>
<span id="cb6-101"><a href="#cb6-101" aria-hidden="true" tabindex="-1"></a>            beta,</span>
<span id="cb6-102"><a href="#cb6-102" aria-hidden="true" tabindex="-1"></a>            sigma,</span>
<span id="cb6-103"><a href="#cb6-103" aria-hidden="true" tabindex="-1"></a>            returnOnStorage,</span>
<span id="cb6-104"><a href="#cb6-104" aria-hidden="true" tabindex="-1"></a>            incomeTransitionMatrix[stateIndex,],</span>
<span id="cb6-105"><a href="#cb6-105" aria-hidden="true" tabindex="-1"></a>            storageGridPoints,</span>
<span id="cb6-106"><a href="#cb6-106" aria-hidden="true" tabindex="-1"></a>            consumptionAutarkyMatrix</span>
<span id="cb6-107"><a href="#cb6-107" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">&gt;=</span> <span class="dv">0</span>) {</span>
<span id="cb6-108"><a href="#cb6-108" aria-hidden="true" tabindex="-1"></a>          consumptionAutarkyMatrixNew[stateIndex, storageIndex] <span class="ot">&lt;-</span> (</span>
<span id="cb6-109"><a href="#cb6-109" aria-hidden="true" tabindex="-1"></a>            storageGridPoints[storageIndex] <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> returnOnStorage) <span class="sc">+</span> incomeGridPoints[stateIndex]</span>
<span id="cb6-110"><a href="#cb6-110" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb6-111"><a href="#cb6-111" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb6-112"><a href="#cb6-112" aria-hidden="true" tabindex="-1"></a>          consumptionAutarkyMatrixNew[stateIndex, storageIndex] <span class="ot">&lt;-</span> <span class="fu">uniroot</span>(</span>
<span id="cb6-113"><a href="#cb6-113" aria-hidden="true" tabindex="-1"></a>          <span class="cf">function</span>(x) {<span class="fu">calculateEulerEquationDiffAutarky</span>(</span>
<span id="cb6-114"><a href="#cb6-114" aria-hidden="true" tabindex="-1"></a>            x,</span>
<span id="cb6-115"><a href="#cb6-115" aria-hidden="true" tabindex="-1"></a>            incomeGridPoints[stateIndex],</span>
<span id="cb6-116"><a href="#cb6-116" aria-hidden="true" tabindex="-1"></a>            storageGridPoints[storageIndex],</span>
<span id="cb6-117"><a href="#cb6-117" aria-hidden="true" tabindex="-1"></a>            beta,</span>
<span id="cb6-118"><a href="#cb6-118" aria-hidden="true" tabindex="-1"></a>            sigma,</span>
<span id="cb6-119"><a href="#cb6-119" aria-hidden="true" tabindex="-1"></a>            returnOnStorage,</span>
<span id="cb6-120"><a href="#cb6-120" aria-hidden="true" tabindex="-1"></a>            incomeTransitionMatrix[stateIndex, ],</span>
<span id="cb6-121"><a href="#cb6-121" aria-hidden="true" tabindex="-1"></a>            storageGridPoints,</span>
<span id="cb6-122"><a href="#cb6-122" aria-hidden="true" tabindex="-1"></a>            consumptionAutarkyMatrix</span>
<span id="cb6-123"><a href="#cb6-123" aria-hidden="true" tabindex="-1"></a>            )},</span>
<span id="cb6-124"><a href="#cb6-124" aria-hidden="true" tabindex="-1"></a>            <span class="fu">c</span>(</span>
<span id="cb6-125"><a href="#cb6-125" aria-hidden="true" tabindex="-1"></a>              <span class="fl">1e-12</span>, </span>
<span id="cb6-126"><a href="#cb6-126" aria-hidden="true" tabindex="-1"></a>              storageGridPoints[storageIndex] <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> returnOnStorage) <span class="sc">+</span> incomeGridPoints[stateIndex]</span>
<span id="cb6-127"><a href="#cb6-127" aria-hidden="true" tabindex="-1"></a>              )</span>
<span id="cb6-128"><a href="#cb6-128" aria-hidden="true" tabindex="-1"></a>          )<span class="sc">$</span>root</span>
<span id="cb6-129"><a href="#cb6-129" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb6-130"><a href="#cb6-130" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb6-131"><a href="#cb6-131" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb6-132"><a href="#cb6-132" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-133"><a href="#cb6-133" aria-hidden="true" tabindex="-1"></a>    diff <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="fu">abs</span>(consumptionAutarkyMatrixNew <span class="sc">-</span> consumptionAutarkyMatrix))</span>
<span id="cb6-134"><a href="#cb6-134" aria-hidden="true" tabindex="-1"></a>    consumptionAutarkyMatrix <span class="ot">&lt;-</span> consumptionAutarkyMatrixNew</span>
<span id="cb6-135"><a href="#cb6-135" aria-hidden="true" tabindex="-1"></a>    iter <span class="ot">&lt;-</span> iter <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb6-136"><a href="#cb6-136" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb6-137"><a href="#cb6-137" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-138"><a href="#cb6-138" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(consumptionAutarkyMatrix)</span>
<span id="cb6-139"><a href="#cb6-139" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-140"><a href="#cb6-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-141"><a href="#cb6-141" aria-hidden="true" tabindex="-1"></a>computeValueAutarky <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb6-142"><a href="#cb6-142" aria-hidden="true" tabindex="-1"></a>    consumptionAutarkyMatrix,</span>
<span id="cb6-143"><a href="#cb6-143" aria-hidden="true" tabindex="-1"></a>    returnOnStorage,</span>
<span id="cb6-144"><a href="#cb6-144" aria-hidden="true" tabindex="-1"></a>    storageGridPoints,</span>
<span id="cb6-145"><a href="#cb6-145" aria-hidden="true" tabindex="-1"></a>    incomeGridPoints,</span>
<span id="cb6-146"><a href="#cb6-146" aria-hidden="true" tabindex="-1"></a>    beta,</span>
<span id="cb6-147"><a href="#cb6-147" aria-hidden="true" tabindex="-1"></a>    sigma,</span>
<span id="cb6-148"><a href="#cb6-148" aria-hidden="true" tabindex="-1"></a>    incomeProb,</span>
<span id="cb6-149"><a href="#cb6-149" aria-hidden="true" tabindex="-1"></a>    numStates,</span>
<span id="cb6-150"><a href="#cb6-150" aria-hidden="true" tabindex="-1"></a>    numStorageGridPoints,</span>
<span id="cb6-151"><a href="#cb6-151" aria-hidden="true" tabindex="-1"></a>    <span class="at">iterationTol =</span> <span class="fl">1e-8</span>,</span>
<span id="cb6-152"><a href="#cb6-152" aria-hidden="true" tabindex="-1"></a>    <span class="at">maxIteration =</span> <span class="dv">100</span></span>
<span id="cb6-153"><a href="#cb6-153" aria-hidden="true" tabindex="-1"></a>) {</span>
<span id="cb6-154"><a href="#cb6-154" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-155"><a href="#cb6-155" aria-hidden="true" tabindex="-1"></a>  valueAutarkyMatrix <span class="ot">&lt;-</span> <span class="fu">calculateUtility</span>(consumptionAutarkyMatrix, sigma) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> beta)</span>
<span id="cb6-156"><a href="#cb6-156" aria-hidden="true" tabindex="-1"></a>  valueAutarkyMatrixNew <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> numStates, <span class="at">ncol =</span> numStorageGridPoints)</span>
<span id="cb6-157"><a href="#cb6-157" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-158"><a href="#cb6-158" aria-hidden="true" tabindex="-1"></a>  iter <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb6-159"><a href="#cb6-159" aria-hidden="true" tabindex="-1"></a>  diff <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb6-160"><a href="#cb6-160" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> ((diff <span class="sc">&gt;</span> iterationTol) <span class="sc">&amp;</span> (iter <span class="sc">&lt;</span> maxIteration)) {</span>
<span id="cb6-161"><a href="#cb6-161" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-162"><a href="#cb6-162" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (stateIndex <span class="cf">in</span> <span class="fu">seq</span>(<span class="dv">1</span>, numStates)) {</span>
<span id="cb6-163"><a href="#cb6-163" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (storageIndex <span class="cf">in</span> <span class="fu">seq</span>(<span class="dv">1</span>, numStorageGridPoints)) {</span>
<span id="cb6-164"><a href="#cb6-164" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-165"><a href="#cb6-165" aria-hidden="true" tabindex="-1"></a>        interpolatedValueByIncome <span class="ot">&lt;-</span> <span class="fu">interpolateValueByIncome</span>(</span>
<span id="cb6-166"><a href="#cb6-166" aria-hidden="true" tabindex="-1"></a>          consumptionAutarkyMatrix[stateIndex, storageIndex],</span>
<span id="cb6-167"><a href="#cb6-167" aria-hidden="true" tabindex="-1"></a>          incomeGridPoints[stateIndex],</span>
<span id="cb6-168"><a href="#cb6-168" aria-hidden="true" tabindex="-1"></a>          storageGridPoints[storageIndex],</span>
<span id="cb6-169"><a href="#cb6-169" aria-hidden="true" tabindex="-1"></a>          valueAutarkyMatrix,</span>
<span id="cb6-170"><a href="#cb6-170" aria-hidden="true" tabindex="-1"></a>          storageGridPoints,</span>
<span id="cb6-171"><a href="#cb6-171" aria-hidden="true" tabindex="-1"></a>          returnOnStorage</span>
<span id="cb6-172"><a href="#cb6-172" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb6-173"><a href="#cb6-173" aria-hidden="true" tabindex="-1"></a>        valueAutarkyMatrixNew[stateIndex, storageIndex] <span class="ot">&lt;-</span> <span class="fu">updateValueAutarky</span>(</span>
<span id="cb6-174"><a href="#cb6-174" aria-hidden="true" tabindex="-1"></a>          consumptionAutarkyMatrix[stateIndex, storageIndex],</span>
<span id="cb6-175"><a href="#cb6-175" aria-hidden="true" tabindex="-1"></a>          interpolatedValueByIncome,</span>
<span id="cb6-176"><a href="#cb6-176" aria-hidden="true" tabindex="-1"></a>          incomeTransitionMatrix[stateIndex,],</span>
<span id="cb6-177"><a href="#cb6-177" aria-hidden="true" tabindex="-1"></a>          beta,</span>
<span id="cb6-178"><a href="#cb6-178" aria-hidden="true" tabindex="-1"></a>          sigma</span>
<span id="cb6-179"><a href="#cb6-179" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> as.numeric</span>
<span id="cb6-180"><a href="#cb6-180" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb6-181"><a href="#cb6-181" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb6-182"><a href="#cb6-182" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-183"><a href="#cb6-183" aria-hidden="true" tabindex="-1"></a>    diff <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="fu">abs</span>(valueAutarkyMatrixNew <span class="sc">-</span> valueAutarkyMatrix))</span>
<span id="cb6-184"><a href="#cb6-184" aria-hidden="true" tabindex="-1"></a>    valueAutarkyMatrix <span class="ot">&lt;-</span> valueAutarkyMatrixNew</span>
<span id="cb6-185"><a href="#cb6-185" aria-hidden="true" tabindex="-1"></a>    iter <span class="ot">&lt;-</span> iter <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb6-186"><a href="#cb6-186" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-187"><a href="#cb6-187" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb6-188"><a href="#cb6-188" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-189"><a href="#cb6-189" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(valueAutarkyMatrix)</span>
<span id="cb6-190"><a href="#cb6-190" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-191"><a href="#cb6-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-192"><a href="#cb6-192" aria-hidden="true" tabindex="-1"></a>solveValueAutarky <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb6-193"><a href="#cb6-193" aria-hidden="true" tabindex="-1"></a>    returnOnStorage,</span>
<span id="cb6-194"><a href="#cb6-194" aria-hidden="true" tabindex="-1"></a>    storageGridPoints,</span>
<span id="cb6-195"><a href="#cb6-195" aria-hidden="true" tabindex="-1"></a>    incomeGridPoints,</span>
<span id="cb6-196"><a href="#cb6-196" aria-hidden="true" tabindex="-1"></a>    beta,</span>
<span id="cb6-197"><a href="#cb6-197" aria-hidden="true" tabindex="-1"></a>    sigma,</span>
<span id="cb6-198"><a href="#cb6-198" aria-hidden="true" tabindex="-1"></a>    incomeProb,</span>
<span id="cb6-199"><a href="#cb6-199" aria-hidden="true" tabindex="-1"></a>    numStates,</span>
<span id="cb6-200"><a href="#cb6-200" aria-hidden="true" tabindex="-1"></a>    numStorageGridPoints</span>
<span id="cb6-201"><a href="#cb6-201" aria-hidden="true" tabindex="-1"></a>) {</span>
<span id="cb6-202"><a href="#cb6-202" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-203"><a href="#cb6-203" aria-hidden="true" tabindex="-1"></a>  consumptionAutarkyMatrix <span class="ot">&lt;-</span> <span class="fu">computeConsumptionAutarky</span>(</span>
<span id="cb6-204"><a href="#cb6-204" aria-hidden="true" tabindex="-1"></a>      returnOnStorage,</span>
<span id="cb6-205"><a href="#cb6-205" aria-hidden="true" tabindex="-1"></a>      storageGridPoints,</span>
<span id="cb6-206"><a href="#cb6-206" aria-hidden="true" tabindex="-1"></a>      incomeGridPoints,</span>
<span id="cb6-207"><a href="#cb6-207" aria-hidden="true" tabindex="-1"></a>      beta,</span>
<span id="cb6-208"><a href="#cb6-208" aria-hidden="true" tabindex="-1"></a>      sigma,</span>
<span id="cb6-209"><a href="#cb6-209" aria-hidden="true" tabindex="-1"></a>      incomeProb,</span>
<span id="cb6-210"><a href="#cb6-210" aria-hidden="true" tabindex="-1"></a>      numStates,</span>
<span id="cb6-211"><a href="#cb6-211" aria-hidden="true" tabindex="-1"></a>      numStorageGridPoints</span>
<span id="cb6-212"><a href="#cb6-212" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb6-213"><a href="#cb6-213" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-214"><a href="#cb6-214" aria-hidden="true" tabindex="-1"></a>  valueAutarkyMatrix <span class="ot">&lt;-</span> <span class="fu">computeValueAutarky</span>(</span>
<span id="cb6-215"><a href="#cb6-215" aria-hidden="true" tabindex="-1"></a>      consumptionAutarkyMatrix,</span>
<span id="cb6-216"><a href="#cb6-216" aria-hidden="true" tabindex="-1"></a>      returnOnStorage,</span>
<span id="cb6-217"><a href="#cb6-217" aria-hidden="true" tabindex="-1"></a>      storageGridPoints,</span>
<span id="cb6-218"><a href="#cb6-218" aria-hidden="true" tabindex="-1"></a>      incomeGridPoints,</span>
<span id="cb6-219"><a href="#cb6-219" aria-hidden="true" tabindex="-1"></a>      beta,</span>
<span id="cb6-220"><a href="#cb6-220" aria-hidden="true" tabindex="-1"></a>      sigma,</span>
<span id="cb6-221"><a href="#cb6-221" aria-hidden="true" tabindex="-1"></a>      incomeProb,</span>
<span id="cb6-222"><a href="#cb6-222" aria-hidden="true" tabindex="-1"></a>      numStates,</span>
<span id="cb6-223"><a href="#cb6-223" aria-hidden="true" tabindex="-1"></a>      numStorageGridPoints</span>
<span id="cb6-224"><a href="#cb6-224" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb6-225"><a href="#cb6-225" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-226"><a href="#cb6-226" aria-hidden="true" tabindex="-1"></a>  valueAutarkyZeroPrivateSaving <span class="ot">&lt;-</span> valueAutarkyMatrix[, <span class="dv">1</span>]</span>
<span id="cb6-227"><a href="#cb6-227" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-228"><a href="#cb6-228" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(valueAutarkyZeroPrivateSaving)</span>
<span id="cb6-229"><a href="#cb6-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-230"><a href="#cb6-230" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="model-with-storage-and-limited-commitment" class="level3" data-number="2.2.3">
<h3 data-number="2.2.3" class="anchored" data-anchor-id="model-with-storage-and-limited-commitment"><span class="header-section-number">2.2.3</span> Model with storage and limited commitment</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>calculateHH1Consumption <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  aggregateResources,</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  relativeParetoWeight,</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  sigma</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>) {</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    aggregateResources <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> (relativeParetoWeight<span class="sc">^</span>(<span class="dv">1</span> <span class="sc">/</span> sigma)))</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>calculateHH2Consumption <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  aggregateResources,</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  relativeParetoWeight,</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>  sigma</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>) {</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>  (</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    aggregateResources </span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span> aggregateResources <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> (relativeParetoWeight<span class="sc">^</span>(<span class="dv">1</span> <span class="sc">/</span> sigma)))</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>calculateEulerEquationDiff <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    aggregateIncome,</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    currentStorage,</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    currentRelativeParetoWeight,</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    returnOnStorage,</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    nextPeriodStorage,</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    aggregateIncomeGridPoints,</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    relativeParetoWeightsGridPoints,</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    nextStorageArray,</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    relativeParetoWeightsBoundsArray,</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    incomeTransitionProbVec,</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    storageGridPoints,</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    numStates,</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    sigma,</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    beta</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>) {</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>  nextRelativeParetoWeight <span class="ot">&lt;-</span> <span class="fu">map_dbl</span>(</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">seq</span>(<span class="dv">1</span>, numStates),</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(x) {</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>      currentRelativeParetoWeight <span class="sc">%&gt;%</span> </span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>        <span class="fu">pmax</span>(</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>          <span class="fu">approx</span>(</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>            storageGridPoints,</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>            relativeParetoWeightsBoundsArray[<span class="dv">1</span>, x, ],</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>            nextPeriodStorage,</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>            <span class="at">rule =</span> <span class="dv">2</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>          )<span class="sc">$</span>y</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> </span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>        <span class="fu">pmin</span>(</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>          <span class="fu">approx</span>(</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>            storageGridPoints,</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>            relativeParetoWeightsBoundsArray[<span class="dv">2</span>, x, ],</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>            nextPeriodStorage,</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>            <span class="at">rule =</span> <span class="dv">2</span></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>          )<span class="sc">$</span>y</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>  nu <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> (nextRelativeParetoWeight <span class="sc">/</span> currentRelativeParetoWeight)) <span class="sc">%&gt;%</span> <span class="fu">pmax</span>(<span class="dv">0</span>)</span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(</span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">calculateMarginalUtility</span>(</span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>      <span class="fu">calculateHH1Consumption</span>(</span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>          aggregateIncome</span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>          <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">+</span> returnOnStorage) <span class="sc">*</span> currentStorage <span class="sc">-</span> nextPeriodStorage,</span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>          currentRelativeParetoWeight,</span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>          sigma</span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>      sigma</span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">-</span> (</span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a>      beta <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> returnOnStorage) <span class="sc">*</span> incomeTransitionProbVec <span class="sc">%*%</span> (</span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a>        <span class="fu">calculateMarginalUtility</span>(</span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>          <span class="fu">calculateHH1Consumption</span>(</span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a>            aggregateIncomeGridPoints </span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a>            <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">+</span> returnOnStorage) <span class="sc">*</span> nextPeriodStorage </span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a>            <span class="sc">-</span> <span class="fu">map_dbl</span>(</span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a>              <span class="fu">seq</span>(<span class="dv">1</span>, numStates),</span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a>              <span class="cf">function</span>(xx) <span class="fu">interp2</span>(</span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a>                <span class="at">x =</span> storageGridPoints,</span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a>                <span class="at">y =</span> relativeParetoWeightsGridPoints,</span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a>                <span class="at">Z =</span> nextStorageArray[xx, , ],</span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a>                <span class="at">xp =</span> nextPeriodStorage <span class="sc">%&gt;%</span> </span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">pmin</span>(<span class="fu">max</span>(storageGridPoints)) <span class="sc">%&gt;%</span> </span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">pmax</span>(<span class="fu">min</span>(storageGridPoints)),</span>
<span id="cb8-67"><a href="#cb8-67" aria-hidden="true" tabindex="-1"></a>                <span class="at">yp =</span> nextRelativeParetoWeight[xx] <span class="sc">%&gt;%</span></span>
<span id="cb8-68"><a href="#cb8-68" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">pmin</span>(<span class="fu">max</span>(relativeParetoWeightsGridPoints)) <span class="sc">%&gt;%</span></span>
<span id="cb8-69"><a href="#cb8-69" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">pmax</span>(<span class="fu">min</span>(relativeParetoWeightsGridPoints)),</span>
<span id="cb8-70"><a href="#cb8-70" aria-hidden="true" tabindex="-1"></a>                <span class="at">method =</span> <span class="st">"linear"</span></span>
<span id="cb8-71"><a href="#cb8-71" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb8-72"><a href="#cb8-72" aria-hidden="true" tabindex="-1"></a>              ),</span>
<span id="cb8-73"><a href="#cb8-73" aria-hidden="true" tabindex="-1"></a>            nextRelativeParetoWeight,</span>
<span id="cb8-74"><a href="#cb8-74" aria-hidden="true" tabindex="-1"></a>            sigma</span>
<span id="cb8-75"><a href="#cb8-75" aria-hidden="true" tabindex="-1"></a>          ),</span>
<span id="cb8-76"><a href="#cb8-76" aria-hidden="true" tabindex="-1"></a>          sigma</span>
<span id="cb8-77"><a href="#cb8-77" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> nu)</span>
<span id="cb8-78"><a href="#cb8-78" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> as.numeric </span>
<span id="cb8-79"><a href="#cb8-79" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-80"><a href="#cb8-80" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb8-81"><a href="#cb8-81" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-82"><a href="#cb8-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-83"><a href="#cb8-83" aria-hidden="true" tabindex="-1"></a>calculateValue <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb8-84"><a href="#cb8-84" aria-hidden="true" tabindex="-1"></a>    aggregateIncome,</span>
<span id="cb8-85"><a href="#cb8-85" aria-hidden="true" tabindex="-1"></a>    currentStorage,</span>
<span id="cb8-86"><a href="#cb8-86" aria-hidden="true" tabindex="-1"></a>    currentRelativeParetoWeight,</span>
<span id="cb8-87"><a href="#cb8-87" aria-hidden="true" tabindex="-1"></a>    returnOnStorage,</span>
<span id="cb8-88"><a href="#cb8-88" aria-hidden="true" tabindex="-1"></a>    nextPeriodStorage,</span>
<span id="cb8-89"><a href="#cb8-89" aria-hidden="true" tabindex="-1"></a>    relativeParetoWeightsGridPoints,</span>
<span id="cb8-90"><a href="#cb8-90" aria-hidden="true" tabindex="-1"></a>    valueArray,</span>
<span id="cb8-91"><a href="#cb8-91" aria-hidden="true" tabindex="-1"></a>    incomeTransitionProbVec,</span>
<span id="cb8-92"><a href="#cb8-92" aria-hidden="true" tabindex="-1"></a>    storageGridPoints,</span>
<span id="cb8-93"><a href="#cb8-93" aria-hidden="true" tabindex="-1"></a>    numStates,</span>
<span id="cb8-94"><a href="#cb8-94" aria-hidden="true" tabindex="-1"></a>    sigma,</span>
<span id="cb8-95"><a href="#cb8-95" aria-hidden="true" tabindex="-1"></a>    beta,</span>
<span id="cb8-96"><a href="#cb8-96" aria-hidden="true" tabindex="-1"></a>    calculateHouseholdConsumption</span>
<span id="cb8-97"><a href="#cb8-97" aria-hidden="true" tabindex="-1"></a>) {</span>
<span id="cb8-98"><a href="#cb8-98" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb8-99"><a href="#cb8-99" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(</span>
<span id="cb8-100"><a href="#cb8-100" aria-hidden="true" tabindex="-1"></a>    <span class="fu">calculateUtility</span>(</span>
<span id="cb8-101"><a href="#cb8-101" aria-hidden="true" tabindex="-1"></a>      <span class="fu">calculateHouseholdConsumption</span>(</span>
<span id="cb8-102"><a href="#cb8-102" aria-hidden="true" tabindex="-1"></a>        aggregateIncome</span>
<span id="cb8-103"><a href="#cb8-103" aria-hidden="true" tabindex="-1"></a>          <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">+</span> returnOnStorage) <span class="sc">*</span> currentStorage</span>
<span id="cb8-104"><a href="#cb8-104" aria-hidden="true" tabindex="-1"></a>          <span class="sc">-</span> nextPeriodStorage,</span>
<span id="cb8-105"><a href="#cb8-105" aria-hidden="true" tabindex="-1"></a>        currentRelativeParetoWeight,</span>
<span id="cb8-106"><a href="#cb8-106" aria-hidden="true" tabindex="-1"></a>        sigma</span>
<span id="cb8-107"><a href="#cb8-107" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> <span class="fu">pmax</span>(<span class="fl">1e-12</span>)</span>
<span id="cb8-108"><a href="#cb8-108" aria-hidden="true" tabindex="-1"></a>      , sigma</span>
<span id="cb8-109"><a href="#cb8-109" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span> (</span>
<span id="cb8-110"><a href="#cb8-110" aria-hidden="true" tabindex="-1"></a>      beta </span>
<span id="cb8-111"><a href="#cb8-111" aria-hidden="true" tabindex="-1"></a>      <span class="sc">*</span> incomeTransitionProbVec </span>
<span id="cb8-112"><a href="#cb8-112" aria-hidden="true" tabindex="-1"></a>      <span class="sc">%*%</span> <span class="fu">map_dbl</span>(</span>
<span id="cb8-113"><a href="#cb8-113" aria-hidden="true" tabindex="-1"></a>        <span class="fu">seq</span>(<span class="dv">1</span>, numStates),</span>
<span id="cb8-114"><a href="#cb8-114" aria-hidden="true" tabindex="-1"></a>        <span class="cf">function</span>(xx) {<span class="fu">interp2</span>(</span>
<span id="cb8-115"><a href="#cb8-115" aria-hidden="true" tabindex="-1"></a>            <span class="at">x =</span> storageGridPoints,</span>
<span id="cb8-116"><a href="#cb8-116" aria-hidden="true" tabindex="-1"></a>            <span class="at">y =</span> relativeParetoWeightsGridPoints,</span>
<span id="cb8-117"><a href="#cb8-117" aria-hidden="true" tabindex="-1"></a>            <span class="at">Z =</span> valueArray[xx, , ],</span>
<span id="cb8-118"><a href="#cb8-118" aria-hidden="true" tabindex="-1"></a>            <span class="at">xp =</span> nextPeriodStorage <span class="sc">%&gt;%</span> </span>
<span id="cb8-119"><a href="#cb8-119" aria-hidden="true" tabindex="-1"></a>              <span class="fu">pmin</span>(<span class="fu">max</span>(storageGridPoints)) <span class="sc">%&gt;%</span> </span>
<span id="cb8-120"><a href="#cb8-120" aria-hidden="true" tabindex="-1"></a>              <span class="fu">pmax</span>(<span class="fu">min</span>(storageGridPoints)),</span>
<span id="cb8-121"><a href="#cb8-121" aria-hidden="true" tabindex="-1"></a>            <span class="at">yp =</span> currentRelativeParetoWeight <span class="sc">%&gt;%</span> </span>
<span id="cb8-122"><a href="#cb8-122" aria-hidden="true" tabindex="-1"></a>              <span class="fu">pmin</span>(<span class="fu">max</span>(relativeParetoWeightsGridPoints)) <span class="sc">%&gt;%</span> </span>
<span id="cb8-123"><a href="#cb8-123" aria-hidden="true" tabindex="-1"></a>              <span class="fu">pmax</span>(<span class="fu">min</span>(relativeParetoWeightsGridPoints)),</span>
<span id="cb8-124"><a href="#cb8-124" aria-hidden="true" tabindex="-1"></a>            <span class="at">method =</span> <span class="st">"linear"</span></span>
<span id="cb8-125"><a href="#cb8-125" aria-hidden="true" tabindex="-1"></a>        )}</span>
<span id="cb8-126"><a href="#cb8-126" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span> as.numeric)</span>
<span id="cb8-127"><a href="#cb8-127" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb8-128"><a href="#cb8-128" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-129"><a href="#cb8-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-130"><a href="#cb8-130" aria-hidden="true" tabindex="-1"></a>calculatePCDiff <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb8-131"><a href="#cb8-131" aria-hidden="true" tabindex="-1"></a>    aggregateIncome,</span>
<span id="cb8-132"><a href="#cb8-132" aria-hidden="true" tabindex="-1"></a>    currentStorage,</span>
<span id="cb8-133"><a href="#cb8-133" aria-hidden="true" tabindex="-1"></a>    currentRelativeParetoWeight,</span>
<span id="cb8-134"><a href="#cb8-134" aria-hidden="true" tabindex="-1"></a>    returnOnStorage,</span>
<span id="cb8-135"><a href="#cb8-135" aria-hidden="true" tabindex="-1"></a>    nextPeriodStorage,</span>
<span id="cb8-136"><a href="#cb8-136" aria-hidden="true" tabindex="-1"></a>    relativeParetoWeightsGridPoints,</span>
<span id="cb8-137"><a href="#cb8-137" aria-hidden="true" tabindex="-1"></a>    valueArray,</span>
<span id="cb8-138"><a href="#cb8-138" aria-hidden="true" tabindex="-1"></a>    valueAutarky,</span>
<span id="cb8-139"><a href="#cb8-139" aria-hidden="true" tabindex="-1"></a>    incomeTransitionProbVec,</span>
<span id="cb8-140"><a href="#cb8-140" aria-hidden="true" tabindex="-1"></a>    storageGridPoints,</span>
<span id="cb8-141"><a href="#cb8-141" aria-hidden="true" tabindex="-1"></a>    numStates,</span>
<span id="cb8-142"><a href="#cb8-142" aria-hidden="true" tabindex="-1"></a>    sigma,</span>
<span id="cb8-143"><a href="#cb8-143" aria-hidden="true" tabindex="-1"></a>    beta,</span>
<span id="cb8-144"><a href="#cb8-144" aria-hidden="true" tabindex="-1"></a>    calculateHouseholdConsumption</span>
<span id="cb8-145"><a href="#cb8-145" aria-hidden="true" tabindex="-1"></a>) {</span>
<span id="cb8-146"><a href="#cb8-146" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(</span>
<span id="cb8-147"><a href="#cb8-147" aria-hidden="true" tabindex="-1"></a>      <span class="fu">calculateValue</span>(</span>
<span id="cb8-148"><a href="#cb8-148" aria-hidden="true" tabindex="-1"></a>        aggregateIncome,</span>
<span id="cb8-149"><a href="#cb8-149" aria-hidden="true" tabindex="-1"></a>        currentStorage,</span>
<span id="cb8-150"><a href="#cb8-150" aria-hidden="true" tabindex="-1"></a>        currentRelativeParetoWeight,</span>
<span id="cb8-151"><a href="#cb8-151" aria-hidden="true" tabindex="-1"></a>        returnOnStorage,</span>
<span id="cb8-152"><a href="#cb8-152" aria-hidden="true" tabindex="-1"></a>        nextPeriodStorage,</span>
<span id="cb8-153"><a href="#cb8-153" aria-hidden="true" tabindex="-1"></a>        relativeParetoWeightsGridPoints,</span>
<span id="cb8-154"><a href="#cb8-154" aria-hidden="true" tabindex="-1"></a>        valueArray,</span>
<span id="cb8-155"><a href="#cb8-155" aria-hidden="true" tabindex="-1"></a>        incomeTransitionProbVec,</span>
<span id="cb8-156"><a href="#cb8-156" aria-hidden="true" tabindex="-1"></a>        storageGridPoints,</span>
<span id="cb8-157"><a href="#cb8-157" aria-hidden="true" tabindex="-1"></a>        numStates,</span>
<span id="cb8-158"><a href="#cb8-158" aria-hidden="true" tabindex="-1"></a>        sigma,</span>
<span id="cb8-159"><a href="#cb8-159" aria-hidden="true" tabindex="-1"></a>        beta,</span>
<span id="cb8-160"><a href="#cb8-160" aria-hidden="true" tabindex="-1"></a>        calculateHouseholdConsumption</span>
<span id="cb8-161"><a href="#cb8-161" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">-</span> valueAutarky</span>
<span id="cb8-162"><a href="#cb8-162" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-163"><a href="#cb8-163" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>solveLCWithStorage <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    beta,</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    sigma,</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    returnOnStorage,</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    numStates,</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    incomeGridPointsHH1,</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    incomeGridPointsHH2,</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    aggregateIncomeGridPoints,</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    incomeTransitionProbVec,</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    incomeTransitionMatrix</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>) {</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>  storageGridPointList <span class="ot">&lt;-</span> <span class="fu">createStorageGridPoints</span>(incomeGridPointsHH1)</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>  storageGridPoints <span class="ot">&lt;-</span> storageGridPointList[[<span class="dv">1</span>]]</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>  numStorageGridPoints <span class="ot">&lt;-</span> storageGridPointList[[<span class="dv">2</span>]]</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>  relativeParetoWeightsGridPoints <span class="ot">&lt;-</span> <span class="fu">createRelativeParetoWeightGridPoints</span>(</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>    returnOnStorage,</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>    storageGridPoints,</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    incomeGridPointsHH1</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>  valueAutarkyHH1 <span class="ot">&lt;-</span> <span class="fu">solveValueAutarky</span>(</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>      returnOnStorage,</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>      storageGridPoints,</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>      incomeGridPointsHH1,</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>      beta,</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>      sigma,</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>      incomeProb,</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>      numStates,</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>      numStorageGridPoints</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>  valueAutarkyHH2 <span class="ot">&lt;-</span> <span class="fu">solveValueAutarky</span>(</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>      returnOnStorage,</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>      storageGridPoints,</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>      incomeGridPointsHH2,</span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>      beta,</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>      sigma,</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>      incomeProb,</span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>      numStates,</span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>      numStorageGridPoints</span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Initial values for value functions:</span></span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># No next-period storage and full-risk sharing</span></span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>  consumptionOnRelativeParetoWeightAndStorageGridHH1 <span class="ot">&lt;-</span> <span class="fu">array</span>(</span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a>    <span class="cn">NA</span>, <span class="at">dim =</span> <span class="fu">c</span>(numStates, numRelativeParetoWeights, numStorageGridPoints)</span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (stateIndex <span class="cf">in</span> <span class="fu">seq</span>(<span class="dv">1</span>, numStates)) {</span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (weightIndex <span class="cf">in</span> <span class="fu">seq</span>(<span class="dv">1</span>, numRelativeParetoWeights)) {</span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a>      consumptionOnRelativeParetoWeightAndStorageGridHH1[stateIndex, weightIndex, ] <span class="ot">&lt;-</span> (</span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a>          <span class="fu">calculateHH1Consumption</span>(</span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a>            aggregateIncomeGridPoints[stateIndex] <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">+</span> returnOnStorage) <span class="sc">*</span> storageGridPoints,</span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a>            relativeParetoWeightsGridPoints[weightIndex],</span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a>            sigma</span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a>  consumptionOnRelativeParetoWeightAndStorageGridHH2 <span class="ot">&lt;-</span> <span class="fu">array</span>(</span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a>    <span class="cn">NA</span>, <span class="at">dim =</span> <span class="fu">c</span>(numStates, numRelativeParetoWeights, numStorageGridPoints)</span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (stateIndex <span class="cf">in</span> <span class="fu">seq</span>(<span class="dv">1</span>, numStates)) {</span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (weightIndex <span class="cf">in</span> <span class="fu">seq</span>(<span class="dv">1</span>, numRelativeParetoWeights)) {</span>
<span id="cb9-66"><a href="#cb9-66" aria-hidden="true" tabindex="-1"></a>      consumptionOnRelativeParetoWeightAndStorageGridHH2[stateIndex, weightIndex, ] <span class="ot">&lt;-</span> (</span>
<span id="cb9-67"><a href="#cb9-67" aria-hidden="true" tabindex="-1"></a>          aggregateIncomeGridPoints[stateIndex] <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">+</span> returnOnStorage) <span class="sc">*</span> storageGridPoints </span>
<span id="cb9-68"><a href="#cb9-68" aria-hidden="true" tabindex="-1"></a>          <span class="sc">-</span> consumptionOnRelativeParetoWeightAndStorageGridHH1[stateIndex, weightIndex, ]</span>
<span id="cb9-69"><a href="#cb9-69" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb9-70"><a href="#cb9-70" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb9-71"><a href="#cb9-71" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb9-72"><a href="#cb9-72" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-73"><a href="#cb9-73" aria-hidden="true" tabindex="-1"></a>  valueArrayHH1 <span class="ot">&lt;-</span> (</span>
<span id="cb9-74"><a href="#cb9-74" aria-hidden="true" tabindex="-1"></a>    <span class="fu">calculateUtility</span>(consumptionOnRelativeParetoWeightAndStorageGridHH1, sigma) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> beta)</span>
<span id="cb9-75"><a href="#cb9-75" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb9-76"><a href="#cb9-76" aria-hidden="true" tabindex="-1"></a>  valueArrayHH2 <span class="ot">&lt;-</span> (</span>
<span id="cb9-77"><a href="#cb9-77" aria-hidden="true" tabindex="-1"></a>    <span class="fu">calculateUtility</span>(consumptionOnRelativeParetoWeightAndStorageGridHH2, sigma) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> beta)</span>
<span id="cb9-78"><a href="#cb9-78" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb9-79"><a href="#cb9-79" aria-hidden="true" tabindex="-1"></a>  valueArrayHH1New <span class="ot">&lt;-</span> valueArrayHH1</span>
<span id="cb9-80"><a href="#cb9-80" aria-hidden="true" tabindex="-1"></a>  valueArrayHH2New <span class="ot">&lt;-</span> valueArrayHH2</span>
<span id="cb9-81"><a href="#cb9-81" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-82"><a href="#cb9-82" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-83"><a href="#cb9-83" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Initial values for interval bounds:</span></span>
<span id="cb9-84"><a href="#cb9-84" aria-hidden="true" tabindex="-1"></a>  <span class="co"># equal allocation only</span></span>
<span id="cb9-85"><a href="#cb9-85" aria-hidden="true" tabindex="-1"></a>  relativeParetoWeightsBoundsArray <span class="ot">&lt;-</span> <span class="fu">array</span>(</span>
<span id="cb9-86"><a href="#cb9-86" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span>, <span class="at">dim =</span> <span class="fu">c</span>(<span class="dv">2</span>, numStates, numStorageGridPoints)</span>
<span id="cb9-87"><a href="#cb9-87" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb9-88"><a href="#cb9-88" aria-hidden="true" tabindex="-1"></a>  relativeParetoWeightsBoundsArrayNew <span class="ot">&lt;-</span> <span class="fu">array</span>(</span>
<span id="cb9-89"><a href="#cb9-89" aria-hidden="true" tabindex="-1"></a>    <span class="cn">NA</span>, <span class="at">dim =</span> <span class="fu">c</span>(<span class="dv">2</span>, numStates, numStorageGridPoints)</span>
<span id="cb9-90"><a href="#cb9-90" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb9-91"><a href="#cb9-91" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-92"><a href="#cb9-92" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Initial values for next period storage:</span></span>
<span id="cb9-93"><a href="#cb9-93" aria-hidden="true" tabindex="-1"></a>  <span class="co"># zero storage</span></span>
<span id="cb9-94"><a href="#cb9-94" aria-hidden="true" tabindex="-1"></a>  nextStorageArray <span class="ot">&lt;-</span> <span class="fu">array</span>(</span>
<span id="cb9-95"><a href="#cb9-95" aria-hidden="true" tabindex="-1"></a>    <span class="dv">0</span>, <span class="at">dim =</span> <span class="fu">c</span>(numStates, numRelativeParetoWeights, numStorageGridPoints)</span>
<span id="cb9-96"><a href="#cb9-96" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-97"><a href="#cb9-97" aria-hidden="true" tabindex="-1"></a>  nextStorageArrayNew <span class="ot">&lt;-</span> <span class="fu">array</span>(</span>
<span id="cb9-98"><a href="#cb9-98" aria-hidden="true" tabindex="-1"></a>    <span class="dv">0</span>, <span class="at">dim =</span> <span class="fu">c</span>(numStates, numRelativeParetoWeights, numStorageGridPoints)</span>
<span id="cb9-99"><a href="#cb9-99" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-100"><a href="#cb9-100" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-101"><a href="#cb9-101" aria-hidden="true" tabindex="-1"></a>  diff <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb9-102"><a href="#cb9-102" aria-hidden="true" tabindex="-1"></a>  iter <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb9-103"><a href="#cb9-103" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> ((diff <span class="sc">&gt;</span> <span class="fl">1e-4</span>) <span class="sc">&amp;</span> (iter <span class="sc">&lt;</span> <span class="dv">120</span>)) {</span>
<span id="cb9-104"><a href="#cb9-104" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-105"><a href="#cb9-105" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (stateIndex <span class="cf">in</span> <span class="fu">seq</span>(<span class="dv">1</span>, numStates)) {</span>
<span id="cb9-106"><a href="#cb9-106" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (storageIndex <span class="cf">in</span> <span class="fu">seq</span>(<span class="dv">1</span>, numStorageGridPoints)) {</span>
<span id="cb9-107"><a href="#cb9-107" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-108"><a href="#cb9-108" aria-hidden="true" tabindex="-1"></a>        <span class="co"># (i) Find upper bound</span></span>
<span id="cb9-109"><a href="#cb9-109" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (</span>
<span id="cb9-110"><a href="#cb9-110" aria-hidden="true" tabindex="-1"></a>          <span class="fu">calculatePCDiff</span>(</span>
<span id="cb9-111"><a href="#cb9-111" aria-hidden="true" tabindex="-1"></a>                aggregateIncomeGridPoints[stateIndex],</span>
<span id="cb9-112"><a href="#cb9-112" aria-hidden="true" tabindex="-1"></a>                <span class="at">currentStorage =</span> storageGridPoints[storageIndex],</span>
<span id="cb9-113"><a href="#cb9-113" aria-hidden="true" tabindex="-1"></a>                <span class="at">currentRelativeParetoWeight =</span> <span class="fu">max</span>(relativeParetoWeightsGridPoints),</span>
<span id="cb9-114"><a href="#cb9-114" aria-hidden="true" tabindex="-1"></a>                returnOnStorage,</span>
<span id="cb9-115"><a href="#cb9-115" aria-hidden="true" tabindex="-1"></a>                <span class="at">nextPeriodStorage =</span> <span class="dv">0</span>,</span>
<span id="cb9-116"><a href="#cb9-116" aria-hidden="true" tabindex="-1"></a>                relativeParetoWeightsGridPoints,</span>
<span id="cb9-117"><a href="#cb9-117" aria-hidden="true" tabindex="-1"></a>                <span class="at">valueArray =</span> valueArrayHH1,</span>
<span id="cb9-118"><a href="#cb9-118" aria-hidden="true" tabindex="-1"></a>                <span class="at">valueAutarky =</span> valueAutarkyHH1[stateIndex],</span>
<span id="cb9-119"><a href="#cb9-119" aria-hidden="true" tabindex="-1"></a>                incomeTransitionProbVec,</span>
<span id="cb9-120"><a href="#cb9-120" aria-hidden="true" tabindex="-1"></a>                storageGridPoints,</span>
<span id="cb9-121"><a href="#cb9-121" aria-hidden="true" tabindex="-1"></a>                numStates,</span>
<span id="cb9-122"><a href="#cb9-122" aria-hidden="true" tabindex="-1"></a>                sigma,</span>
<span id="cb9-123"><a href="#cb9-123" aria-hidden="true" tabindex="-1"></a>                beta,</span>
<span id="cb9-124"><a href="#cb9-124" aria-hidden="true" tabindex="-1"></a>                calculateHH1Consumption</span>
<span id="cb9-125"><a href="#cb9-125" aria-hidden="true" tabindex="-1"></a>              ) <span class="sc">&gt;</span> <span class="dv">0</span></span>
<span id="cb9-126"><a href="#cb9-126" aria-hidden="true" tabindex="-1"></a>        ) {</span>
<span id="cb9-127"><a href="#cb9-127" aria-hidden="true" tabindex="-1"></a>          relativeParetoWeightsUpperTmp <span class="ot">&lt;-</span> <span class="fu">max</span>(relativeParetoWeightsGridPoints)</span>
<span id="cb9-128"><a href="#cb9-128" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb9-129"><a href="#cb9-129" aria-hidden="true" tabindex="-1"></a>          relativeParetoWeightsUpperTmp <span class="ot">&lt;-</span> <span class="fu">uniroot</span>(</span>
<span id="cb9-130"><a href="#cb9-130" aria-hidden="true" tabindex="-1"></a>            <span class="cf">function</span>(x) {</span>
<span id="cb9-131"><a href="#cb9-131" aria-hidden="true" tabindex="-1"></a>              <span class="fu">calculatePCDiff</span>(</span>
<span id="cb9-132"><a href="#cb9-132" aria-hidden="true" tabindex="-1"></a>                aggregateIncomeGridPoints[stateIndex],</span>
<span id="cb9-133"><a href="#cb9-133" aria-hidden="true" tabindex="-1"></a>                <span class="at">currentStorage =</span> storageGridPoints[storageIndex],</span>
<span id="cb9-134"><a href="#cb9-134" aria-hidden="true" tabindex="-1"></a>                <span class="at">currentRelativeParetoWeight =</span> x,</span>
<span id="cb9-135"><a href="#cb9-135" aria-hidden="true" tabindex="-1"></a>                returnOnStorage,</span>
<span id="cb9-136"><a href="#cb9-136" aria-hidden="true" tabindex="-1"></a>                <span class="at">nextPeriodStorage =</span> <span class="dv">0</span>,</span>
<span id="cb9-137"><a href="#cb9-137" aria-hidden="true" tabindex="-1"></a>                relativeParetoWeightsGridPoints,</span>
<span id="cb9-138"><a href="#cb9-138" aria-hidden="true" tabindex="-1"></a>                <span class="at">valueArray =</span> valueArrayHH1,</span>
<span id="cb9-139"><a href="#cb9-139" aria-hidden="true" tabindex="-1"></a>                <span class="at">valueAutarky =</span> valueAutarkyHH1[stateIndex],</span>
<span id="cb9-140"><a href="#cb9-140" aria-hidden="true" tabindex="-1"></a>                incomeTransitionProbVec,</span>
<span id="cb9-141"><a href="#cb9-141" aria-hidden="true" tabindex="-1"></a>                storageGridPoints,</span>
<span id="cb9-142"><a href="#cb9-142" aria-hidden="true" tabindex="-1"></a>                numStates,</span>
<span id="cb9-143"><a href="#cb9-143" aria-hidden="true" tabindex="-1"></a>                sigma,</span>
<span id="cb9-144"><a href="#cb9-144" aria-hidden="true" tabindex="-1"></a>                beta,</span>
<span id="cb9-145"><a href="#cb9-145" aria-hidden="true" tabindex="-1"></a>                calculateHH1Consumption</span>
<span id="cb9-146"><a href="#cb9-146" aria-hidden="true" tabindex="-1"></a>              )</span>
<span id="cb9-147"><a href="#cb9-147" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb9-148"><a href="#cb9-148" aria-hidden="true" tabindex="-1"></a>            <span class="fu">c</span>(<span class="fu">min</span>(relativeParetoWeightsGridPoints), <span class="fu">max</span>(relativeParetoWeightsGridPoints))</span>
<span id="cb9-149"><a href="#cb9-149" aria-hidden="true" tabindex="-1"></a>          )<span class="sc">$</span>root</span>
<span id="cb9-150"><a href="#cb9-150" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb9-151"><a href="#cb9-151" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-152"><a href="#cb9-152" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (</span>
<span id="cb9-153"><a href="#cb9-153" aria-hidden="true" tabindex="-1"></a>          <span class="fu">calculateEulerEquationDiff</span>(</span>
<span id="cb9-154"><a href="#cb9-154" aria-hidden="true" tabindex="-1"></a>            aggregateIncomeGridPoints[stateIndex],</span>
<span id="cb9-155"><a href="#cb9-155" aria-hidden="true" tabindex="-1"></a>            storageGridPoints[storageIndex],</span>
<span id="cb9-156"><a href="#cb9-156" aria-hidden="true" tabindex="-1"></a>            <span class="at">currentRelativeParetoWeight =</span> relativeParetoWeightsUpperTmp,</span>
<span id="cb9-157"><a href="#cb9-157" aria-hidden="true" tabindex="-1"></a>            returnOnStorage,</span>
<span id="cb9-158"><a href="#cb9-158" aria-hidden="true" tabindex="-1"></a>            <span class="at">nextPeriodStorage =</span> <span class="dv">0</span>,</span>
<span id="cb9-159"><a href="#cb9-159" aria-hidden="true" tabindex="-1"></a>            aggregateIncomeGridPoints,</span>
<span id="cb9-160"><a href="#cb9-160" aria-hidden="true" tabindex="-1"></a>            relativeParetoWeightsGridPoints,</span>
<span id="cb9-161"><a href="#cb9-161" aria-hidden="true" tabindex="-1"></a>            nextStorageArray,</span>
<span id="cb9-162"><a href="#cb9-162" aria-hidden="true" tabindex="-1"></a>            relativeParetoWeightsBoundsArray,</span>
<span id="cb9-163"><a href="#cb9-163" aria-hidden="true" tabindex="-1"></a>            incomeTransitionProbVec,</span>
<span id="cb9-164"><a href="#cb9-164" aria-hidden="true" tabindex="-1"></a>            storageGridPoints,</span>
<span id="cb9-165"><a href="#cb9-165" aria-hidden="true" tabindex="-1"></a>            numStates,</span>
<span id="cb9-166"><a href="#cb9-166" aria-hidden="true" tabindex="-1"></a>            sigma,</span>
<span id="cb9-167"><a href="#cb9-167" aria-hidden="true" tabindex="-1"></a>            beta</span>
<span id="cb9-168"><a href="#cb9-168" aria-hidden="true" tabindex="-1"></a>            ) <span class="sc">&gt;=</span> <span class="dv">0</span></span>
<span id="cb9-169"><a href="#cb9-169" aria-hidden="true" tabindex="-1"></a>        ) {</span>
<span id="cb9-170"><a href="#cb9-170" aria-hidden="true" tabindex="-1"></a>          nextStorageArrayNew[</span>
<span id="cb9-171"><a href="#cb9-171" aria-hidden="true" tabindex="-1"></a>            stateIndex, </span>
<span id="cb9-172"><a href="#cb9-172" aria-hidden="true" tabindex="-1"></a>            <span class="fu">which.min</span>(<span class="fu">abs</span>(</span>
<span id="cb9-173"><a href="#cb9-173" aria-hidden="true" tabindex="-1"></a>              relativeParetoWeightsUpperTmp <span class="sc">-</span> relativeParetoWeightsGridPoints</span>
<span id="cb9-174"><a href="#cb9-174" aria-hidden="true" tabindex="-1"></a>              )), </span>
<span id="cb9-175"><a href="#cb9-175" aria-hidden="true" tabindex="-1"></a>            storageIndex</span>
<span id="cb9-176"><a href="#cb9-176" aria-hidden="true" tabindex="-1"></a>            ] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb9-177"><a href="#cb9-177" aria-hidden="true" tabindex="-1"></a>          relativeParetoWeightsBoundsArrayNew[<span class="dv">2</span>, stateIndex, storageIndex] <span class="ot">&lt;-</span> relativeParetoWeightsUpperTmp</span>
<span id="cb9-178"><a href="#cb9-178" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb9-179"><a href="#cb9-179" aria-hidden="true" tabindex="-1"></a>          resSolve <span class="ot">&lt;-</span> <span class="fu">nleqslv</span>(</span>
<span id="cb9-180"><a href="#cb9-180" aria-hidden="true" tabindex="-1"></a>            <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="dv">1</span>),</span>
<span id="cb9-181"><a href="#cb9-181" aria-hidden="true" tabindex="-1"></a>            <span class="cf">function</span>(x) {</span>
<span id="cb9-182"><a href="#cb9-182" aria-hidden="true" tabindex="-1"></a>              nextPeriodStorage <span class="ot">&lt;-</span> x[<span class="dv">1</span>]</span>
<span id="cb9-183"><a href="#cb9-183" aria-hidden="true" tabindex="-1"></a>              relativeParetoWeightUpperBound <span class="ot">&lt;-</span> x[<span class="dv">2</span>]</span>
<span id="cb9-184"><a href="#cb9-184" aria-hidden="true" tabindex="-1"></a>              y <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="dv">2</span>)</span>
<span id="cb9-185"><a href="#cb9-185" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb9-186"><a href="#cb9-186" aria-hidden="true" tabindex="-1"></a>              y[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">calculateEulerEquationDiff</span>(</span>
<span id="cb9-187"><a href="#cb9-187" aria-hidden="true" tabindex="-1"></a>                aggregateIncomeGridPoints[stateIndex],</span>
<span id="cb9-188"><a href="#cb9-188" aria-hidden="true" tabindex="-1"></a>                storageGridPoints[storageIndex],</span>
<span id="cb9-189"><a href="#cb9-189" aria-hidden="true" tabindex="-1"></a>                <span class="at">currentRelativeParetoWeight =</span> relativeParetoWeightUpperBound,</span>
<span id="cb9-190"><a href="#cb9-190" aria-hidden="true" tabindex="-1"></a>                returnOnStorage,</span>
<span id="cb9-191"><a href="#cb9-191" aria-hidden="true" tabindex="-1"></a>                <span class="at">nextPeriodStorage =</span> nextPeriodStorage,</span>
<span id="cb9-192"><a href="#cb9-192" aria-hidden="true" tabindex="-1"></a>                aggregateIncomeGridPoints,</span>
<span id="cb9-193"><a href="#cb9-193" aria-hidden="true" tabindex="-1"></a>                relativeParetoWeightsGridPoints,</span>
<span id="cb9-194"><a href="#cb9-194" aria-hidden="true" tabindex="-1"></a>                nextStorageArray,</span>
<span id="cb9-195"><a href="#cb9-195" aria-hidden="true" tabindex="-1"></a>                relativeParetoWeightsBoundsArray,</span>
<span id="cb9-196"><a href="#cb9-196" aria-hidden="true" tabindex="-1"></a>                incomeTransitionProbVec,</span>
<span id="cb9-197"><a href="#cb9-197" aria-hidden="true" tabindex="-1"></a>                storageGridPoints,</span>
<span id="cb9-198"><a href="#cb9-198" aria-hidden="true" tabindex="-1"></a>                numStates,</span>
<span id="cb9-199"><a href="#cb9-199" aria-hidden="true" tabindex="-1"></a>                sigma,</span>
<span id="cb9-200"><a href="#cb9-200" aria-hidden="true" tabindex="-1"></a>                beta</span>
<span id="cb9-201"><a href="#cb9-201" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb9-202"><a href="#cb9-202" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb9-203"><a href="#cb9-203" aria-hidden="true" tabindex="-1"></a>              y[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="fu">calculatePCDiff</span>(</span>
<span id="cb9-204"><a href="#cb9-204" aria-hidden="true" tabindex="-1"></a>                aggregateIncomeGridPoints[stateIndex],</span>
<span id="cb9-205"><a href="#cb9-205" aria-hidden="true" tabindex="-1"></a>                storageGridPoints[storageIndex],</span>
<span id="cb9-206"><a href="#cb9-206" aria-hidden="true" tabindex="-1"></a>                <span class="at">currentRelativeParetoWeight =</span> relativeParetoWeightUpperBound,</span>
<span id="cb9-207"><a href="#cb9-207" aria-hidden="true" tabindex="-1"></a>                returnOnStorage,</span>
<span id="cb9-208"><a href="#cb9-208" aria-hidden="true" tabindex="-1"></a>                <span class="at">nextPeriodStorage =</span> nextPeriodStorage,</span>
<span id="cb9-209"><a href="#cb9-209" aria-hidden="true" tabindex="-1"></a>                relativeParetoWeightsGridPoints,</span>
<span id="cb9-210"><a href="#cb9-210" aria-hidden="true" tabindex="-1"></a>                <span class="at">valueArray =</span> valueArrayHH1,</span>
<span id="cb9-211"><a href="#cb9-211" aria-hidden="true" tabindex="-1"></a>                <span class="at">valueAutarky =</span> valueAutarkyHH1[stateIndex],</span>
<span id="cb9-212"><a href="#cb9-212" aria-hidden="true" tabindex="-1"></a>                incomeTransitionProbVec,</span>
<span id="cb9-213"><a href="#cb9-213" aria-hidden="true" tabindex="-1"></a>                storageGridPoints,</span>
<span id="cb9-214"><a href="#cb9-214" aria-hidden="true" tabindex="-1"></a>                numStates,</span>
<span id="cb9-215"><a href="#cb9-215" aria-hidden="true" tabindex="-1"></a>                sigma,</span>
<span id="cb9-216"><a href="#cb9-216" aria-hidden="true" tabindex="-1"></a>                beta,</span>
<span id="cb9-217"><a href="#cb9-217" aria-hidden="true" tabindex="-1"></a>                calculateHH1Consumption</span>
<span id="cb9-218"><a href="#cb9-218" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb9-219"><a href="#cb9-219" aria-hidden="true" tabindex="-1"></a>              <span class="fu">return</span>(y)</span>
<span id="cb9-220"><a href="#cb9-220" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb9-221"><a href="#cb9-221" aria-hidden="true" tabindex="-1"></a>          )<span class="sc">$</span>x</span>
<span id="cb9-222"><a href="#cb9-222" aria-hidden="true" tabindex="-1"></a>          nextStorageArrayNew[</span>
<span id="cb9-223"><a href="#cb9-223" aria-hidden="true" tabindex="-1"></a>            stateIndex, </span>
<span id="cb9-224"><a href="#cb9-224" aria-hidden="true" tabindex="-1"></a>            <span class="fu">which.min</span>(<span class="fu">abs</span>(</span>
<span id="cb9-225"><a href="#cb9-225" aria-hidden="true" tabindex="-1"></a>              resSolve[<span class="dv">2</span>] <span class="sc">-</span> relativeParetoWeightsGridPoints</span>
<span id="cb9-226"><a href="#cb9-226" aria-hidden="true" tabindex="-1"></a>              )), </span>
<span id="cb9-227"><a href="#cb9-227" aria-hidden="true" tabindex="-1"></a>            storageIndex</span>
<span id="cb9-228"><a href="#cb9-228" aria-hidden="true" tabindex="-1"></a>            ] <span class="ot">&lt;-</span> resSolve[<span class="dv">1</span>]</span>
<span id="cb9-229"><a href="#cb9-229" aria-hidden="true" tabindex="-1"></a>          relativeParetoWeightsBoundsArrayNew[<span class="dv">2</span>, stateIndex, storageIndex] <span class="ot">&lt;-</span> resSolve[<span class="dv">2</span>]</span>
<span id="cb9-230"><a href="#cb9-230" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb9-231"><a href="#cb9-231" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-232"><a href="#cb9-232" aria-hidden="true" tabindex="-1"></a>        <span class="co"># (ii) Find lower bound</span></span>
<span id="cb9-233"><a href="#cb9-233" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (</span>
<span id="cb9-234"><a href="#cb9-234" aria-hidden="true" tabindex="-1"></a>          <span class="fu">calculatePCDiff</span>(</span>
<span id="cb9-235"><a href="#cb9-235" aria-hidden="true" tabindex="-1"></a>            aggregateIncomeGridPoints[stateIndex],</span>
<span id="cb9-236"><a href="#cb9-236" aria-hidden="true" tabindex="-1"></a>            <span class="at">currentStorage =</span> storageGridPoints[storageIndex],</span>
<span id="cb9-237"><a href="#cb9-237" aria-hidden="true" tabindex="-1"></a>            <span class="at">currentRelativeParetoWeight =</span> <span class="fu">min</span>(relativeParetoWeightsGridPoints),</span>
<span id="cb9-238"><a href="#cb9-238" aria-hidden="true" tabindex="-1"></a>            returnOnStorage,</span>
<span id="cb9-239"><a href="#cb9-239" aria-hidden="true" tabindex="-1"></a>            <span class="at">nextPeriodStorage =</span> <span class="dv">0</span>,</span>
<span id="cb9-240"><a href="#cb9-240" aria-hidden="true" tabindex="-1"></a>            relativeParetoWeightsGridPoints,</span>
<span id="cb9-241"><a href="#cb9-241" aria-hidden="true" tabindex="-1"></a>            <span class="at">valueArray =</span> valueArrayHH2,</span>
<span id="cb9-242"><a href="#cb9-242" aria-hidden="true" tabindex="-1"></a>            <span class="at">valueAutarky =</span> valueAutarkyHH2[stateIndex],</span>
<span id="cb9-243"><a href="#cb9-243" aria-hidden="true" tabindex="-1"></a>            incomeTransitionProbVec,</span>
<span id="cb9-244"><a href="#cb9-244" aria-hidden="true" tabindex="-1"></a>            storageGridPoints,</span>
<span id="cb9-245"><a href="#cb9-245" aria-hidden="true" tabindex="-1"></a>            numStates,</span>
<span id="cb9-246"><a href="#cb9-246" aria-hidden="true" tabindex="-1"></a>            sigma,</span>
<span id="cb9-247"><a href="#cb9-247" aria-hidden="true" tabindex="-1"></a>            beta,</span>
<span id="cb9-248"><a href="#cb9-248" aria-hidden="true" tabindex="-1"></a>            calculateHH2Consumption</span>
<span id="cb9-249"><a href="#cb9-249" aria-hidden="true" tabindex="-1"></a>          ) <span class="sc">&gt;</span> <span class="dv">0</span></span>
<span id="cb9-250"><a href="#cb9-250" aria-hidden="true" tabindex="-1"></a>        ) {</span>
<span id="cb9-251"><a href="#cb9-251" aria-hidden="true" tabindex="-1"></a>          relativeParetoWeightsLowerTmp <span class="ot">&lt;-</span> <span class="fu">min</span>(relativeParetoWeightsGridPoints)</span>
<span id="cb9-252"><a href="#cb9-252" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb9-253"><a href="#cb9-253" aria-hidden="true" tabindex="-1"></a>          relativeParetoWeightsLowerTmp <span class="ot">&lt;-</span> <span class="fu">uniroot</span>(</span>
<span id="cb9-254"><a href="#cb9-254" aria-hidden="true" tabindex="-1"></a>            <span class="cf">function</span>(x) {</span>
<span id="cb9-255"><a href="#cb9-255" aria-hidden="true" tabindex="-1"></a>              <span class="fu">calculatePCDiff</span>(</span>
<span id="cb9-256"><a href="#cb9-256" aria-hidden="true" tabindex="-1"></a>                aggregateIncomeGridPoints[stateIndex],</span>
<span id="cb9-257"><a href="#cb9-257" aria-hidden="true" tabindex="-1"></a>                <span class="at">currentStorage =</span> storageGridPoints[storageIndex],</span>
<span id="cb9-258"><a href="#cb9-258" aria-hidden="true" tabindex="-1"></a>                <span class="at">currentRelativeParetoWeight =</span> x,</span>
<span id="cb9-259"><a href="#cb9-259" aria-hidden="true" tabindex="-1"></a>                returnOnStorage,</span>
<span id="cb9-260"><a href="#cb9-260" aria-hidden="true" tabindex="-1"></a>                <span class="at">nextPeriodStorage =</span> <span class="dv">0</span>,</span>
<span id="cb9-261"><a href="#cb9-261" aria-hidden="true" tabindex="-1"></a>                relativeParetoWeightsGridPoints,</span>
<span id="cb9-262"><a href="#cb9-262" aria-hidden="true" tabindex="-1"></a>                <span class="at">valueArray =</span> valueArrayHH2,</span>
<span id="cb9-263"><a href="#cb9-263" aria-hidden="true" tabindex="-1"></a>                <span class="at">valueAutarky =</span> valueAutarkyHH2[stateIndex],</span>
<span id="cb9-264"><a href="#cb9-264" aria-hidden="true" tabindex="-1"></a>                incomeTransitionProbVec,</span>
<span id="cb9-265"><a href="#cb9-265" aria-hidden="true" tabindex="-1"></a>                storageGridPoints,</span>
<span id="cb9-266"><a href="#cb9-266" aria-hidden="true" tabindex="-1"></a>                numStates,</span>
<span id="cb9-267"><a href="#cb9-267" aria-hidden="true" tabindex="-1"></a>                sigma,</span>
<span id="cb9-268"><a href="#cb9-268" aria-hidden="true" tabindex="-1"></a>                beta,</span>
<span id="cb9-269"><a href="#cb9-269" aria-hidden="true" tabindex="-1"></a>                calculateHH2Consumption</span>
<span id="cb9-270"><a href="#cb9-270" aria-hidden="true" tabindex="-1"></a>              )</span>
<span id="cb9-271"><a href="#cb9-271" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb9-272"><a href="#cb9-272" aria-hidden="true" tabindex="-1"></a>            <span class="fu">c</span>(<span class="fu">min</span>(relativeParetoWeightsGridPoints), <span class="fu">max</span>(relativeParetoWeightsGridPoints))</span>
<span id="cb9-273"><a href="#cb9-273" aria-hidden="true" tabindex="-1"></a>          )<span class="sc">$</span>root</span>
<span id="cb9-274"><a href="#cb9-274" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb9-275"><a href="#cb9-275" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-276"><a href="#cb9-276" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (</span>
<span id="cb9-277"><a href="#cb9-277" aria-hidden="true" tabindex="-1"></a>          <span class="fu">calculateEulerEquationDiff</span>(</span>
<span id="cb9-278"><a href="#cb9-278" aria-hidden="true" tabindex="-1"></a>            aggregateIncomeGridPoints[stateIndex],</span>
<span id="cb9-279"><a href="#cb9-279" aria-hidden="true" tabindex="-1"></a>            storageGridPoints[storageIndex],</span>
<span id="cb9-280"><a href="#cb9-280" aria-hidden="true" tabindex="-1"></a>            <span class="at">currentRelativeParetoWeight =</span> relativeParetoWeightsLowerTmp,</span>
<span id="cb9-281"><a href="#cb9-281" aria-hidden="true" tabindex="-1"></a>            returnOnStorage,</span>
<span id="cb9-282"><a href="#cb9-282" aria-hidden="true" tabindex="-1"></a>            <span class="at">nextPeriodStorage =</span> <span class="dv">0</span>,</span>
<span id="cb9-283"><a href="#cb9-283" aria-hidden="true" tabindex="-1"></a>            aggregateIncomeGridPoints,</span>
<span id="cb9-284"><a href="#cb9-284" aria-hidden="true" tabindex="-1"></a>            relativeParetoWeightsGridPoints,</span>
<span id="cb9-285"><a href="#cb9-285" aria-hidden="true" tabindex="-1"></a>            nextStorageArray,</span>
<span id="cb9-286"><a href="#cb9-286" aria-hidden="true" tabindex="-1"></a>            relativeParetoWeightsBoundsArray,</span>
<span id="cb9-287"><a href="#cb9-287" aria-hidden="true" tabindex="-1"></a>            incomeTransitionProbVec,</span>
<span id="cb9-288"><a href="#cb9-288" aria-hidden="true" tabindex="-1"></a>            storageGridPoints,</span>
<span id="cb9-289"><a href="#cb9-289" aria-hidden="true" tabindex="-1"></a>            numStates,</span>
<span id="cb9-290"><a href="#cb9-290" aria-hidden="true" tabindex="-1"></a>            sigma,</span>
<span id="cb9-291"><a href="#cb9-291" aria-hidden="true" tabindex="-1"></a>            beta</span>
<span id="cb9-292"><a href="#cb9-292" aria-hidden="true" tabindex="-1"></a>            ) <span class="sc">&gt;=</span> <span class="dv">0</span></span>
<span id="cb9-293"><a href="#cb9-293" aria-hidden="true" tabindex="-1"></a>        ) {</span>
<span id="cb9-294"><a href="#cb9-294" aria-hidden="true" tabindex="-1"></a>          nextStorageArrayNew[</span>
<span id="cb9-295"><a href="#cb9-295" aria-hidden="true" tabindex="-1"></a>            stateIndex, </span>
<span id="cb9-296"><a href="#cb9-296" aria-hidden="true" tabindex="-1"></a>            <span class="fu">which.min</span>(<span class="fu">abs</span>(</span>
<span id="cb9-297"><a href="#cb9-297" aria-hidden="true" tabindex="-1"></a>              relativeParetoWeightsLowerTmp <span class="sc">-</span> relativeParetoWeightsGridPoints</span>
<span id="cb9-298"><a href="#cb9-298" aria-hidden="true" tabindex="-1"></a>              )), </span>
<span id="cb9-299"><a href="#cb9-299" aria-hidden="true" tabindex="-1"></a>            storageIndex</span>
<span id="cb9-300"><a href="#cb9-300" aria-hidden="true" tabindex="-1"></a>            ] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb9-301"><a href="#cb9-301" aria-hidden="true" tabindex="-1"></a>          relativeParetoWeightsBoundsArrayNew[<span class="dv">1</span>, stateIndex, storageIndex] <span class="ot">&lt;-</span> relativeParetoWeightsLowerTmp</span>
<span id="cb9-302"><a href="#cb9-302" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb9-303"><a href="#cb9-303" aria-hidden="true" tabindex="-1"></a>          resSolve <span class="ot">&lt;-</span> <span class="fu">nleqslv</span>(</span>
<span id="cb9-304"><a href="#cb9-304" aria-hidden="true" tabindex="-1"></a>            <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="dv">1</span>),</span>
<span id="cb9-305"><a href="#cb9-305" aria-hidden="true" tabindex="-1"></a>            <span class="cf">function</span>(x) {</span>
<span id="cb9-306"><a href="#cb9-306" aria-hidden="true" tabindex="-1"></a>              nextPeriodStorage <span class="ot">&lt;-</span> x[<span class="dv">1</span>]</span>
<span id="cb9-307"><a href="#cb9-307" aria-hidden="true" tabindex="-1"></a>              relativeParetoWeightLowerBound <span class="ot">&lt;-</span> x[<span class="dv">2</span>]</span>
<span id="cb9-308"><a href="#cb9-308" aria-hidden="true" tabindex="-1"></a>              y <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="dv">2</span>)</span>
<span id="cb9-309"><a href="#cb9-309" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb9-310"><a href="#cb9-310" aria-hidden="true" tabindex="-1"></a>              y[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">calculateEulerEquationDiff</span>(</span>
<span id="cb9-311"><a href="#cb9-311" aria-hidden="true" tabindex="-1"></a>                aggregateIncomeGridPoints[stateIndex],</span>
<span id="cb9-312"><a href="#cb9-312" aria-hidden="true" tabindex="-1"></a>                storageGridPoints[storageIndex],</span>
<span id="cb9-313"><a href="#cb9-313" aria-hidden="true" tabindex="-1"></a>                <span class="at">currentRelativeParetoWeight =</span> relativeParetoWeightLowerBound,</span>
<span id="cb9-314"><a href="#cb9-314" aria-hidden="true" tabindex="-1"></a>                returnOnStorage,</span>
<span id="cb9-315"><a href="#cb9-315" aria-hidden="true" tabindex="-1"></a>                <span class="at">nextPeriodStorage =</span> nextPeriodStorage,</span>
<span id="cb9-316"><a href="#cb9-316" aria-hidden="true" tabindex="-1"></a>                aggregateIncomeGridPoints,</span>
<span id="cb9-317"><a href="#cb9-317" aria-hidden="true" tabindex="-1"></a>                relativeParetoWeightsGridPoints,</span>
<span id="cb9-318"><a href="#cb9-318" aria-hidden="true" tabindex="-1"></a>                nextStorageArray,</span>
<span id="cb9-319"><a href="#cb9-319" aria-hidden="true" tabindex="-1"></a>                relativeParetoWeightsBoundsArray,</span>
<span id="cb9-320"><a href="#cb9-320" aria-hidden="true" tabindex="-1"></a>                incomeTransitionProbVec,</span>
<span id="cb9-321"><a href="#cb9-321" aria-hidden="true" tabindex="-1"></a>                storageGridPoints,</span>
<span id="cb9-322"><a href="#cb9-322" aria-hidden="true" tabindex="-1"></a>                numStates,</span>
<span id="cb9-323"><a href="#cb9-323" aria-hidden="true" tabindex="-1"></a>                sigma,</span>
<span id="cb9-324"><a href="#cb9-324" aria-hidden="true" tabindex="-1"></a>                beta</span>
<span id="cb9-325"><a href="#cb9-325" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb9-326"><a href="#cb9-326" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb9-327"><a href="#cb9-327" aria-hidden="true" tabindex="-1"></a>              y[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="fu">calculatePCDiff</span>(</span>
<span id="cb9-328"><a href="#cb9-328" aria-hidden="true" tabindex="-1"></a>                aggregateIncomeGridPoints[stateIndex],</span>
<span id="cb9-329"><a href="#cb9-329" aria-hidden="true" tabindex="-1"></a>                storageGridPoints[storageIndex],</span>
<span id="cb9-330"><a href="#cb9-330" aria-hidden="true" tabindex="-1"></a>                <span class="at">currentRelativeParetoWeight =</span> relativeParetoWeightLowerBound,</span>
<span id="cb9-331"><a href="#cb9-331" aria-hidden="true" tabindex="-1"></a>                returnOnStorage,</span>
<span id="cb9-332"><a href="#cb9-332" aria-hidden="true" tabindex="-1"></a>                <span class="at">nextPeriodStorage =</span> nextPeriodStorage,</span>
<span id="cb9-333"><a href="#cb9-333" aria-hidden="true" tabindex="-1"></a>                relativeParetoWeightsGridPoints,</span>
<span id="cb9-334"><a href="#cb9-334" aria-hidden="true" tabindex="-1"></a>                <span class="at">valueArray =</span> valueArrayHH2,</span>
<span id="cb9-335"><a href="#cb9-335" aria-hidden="true" tabindex="-1"></a>                <span class="at">valueAutarky =</span> valueAutarkyHH2[stateIndex],</span>
<span id="cb9-336"><a href="#cb9-336" aria-hidden="true" tabindex="-1"></a>                incomeTransitionProbVec,</span>
<span id="cb9-337"><a href="#cb9-337" aria-hidden="true" tabindex="-1"></a>                storageGridPoints,</span>
<span id="cb9-338"><a href="#cb9-338" aria-hidden="true" tabindex="-1"></a>                numStates,</span>
<span id="cb9-339"><a href="#cb9-339" aria-hidden="true" tabindex="-1"></a>                sigma,</span>
<span id="cb9-340"><a href="#cb9-340" aria-hidden="true" tabindex="-1"></a>                beta,</span>
<span id="cb9-341"><a href="#cb9-341" aria-hidden="true" tabindex="-1"></a>                calculateHH2Consumption</span>
<span id="cb9-342"><a href="#cb9-342" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb9-343"><a href="#cb9-343" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb9-344"><a href="#cb9-344" aria-hidden="true" tabindex="-1"></a>              <span class="fu">return</span>(y)</span>
<span id="cb9-345"><a href="#cb9-345" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb9-346"><a href="#cb9-346" aria-hidden="true" tabindex="-1"></a>          )<span class="sc">$</span>x</span>
<span id="cb9-347"><a href="#cb9-347" aria-hidden="true" tabindex="-1"></a>          nextStorageArrayNew[</span>
<span id="cb9-348"><a href="#cb9-348" aria-hidden="true" tabindex="-1"></a>            stateIndex, </span>
<span id="cb9-349"><a href="#cb9-349" aria-hidden="true" tabindex="-1"></a>            <span class="fu">which.min</span>(<span class="fu">abs</span>(</span>
<span id="cb9-350"><a href="#cb9-350" aria-hidden="true" tabindex="-1"></a>              resSolve[<span class="dv">2</span>] <span class="sc">-</span> relativeParetoWeightsGridPoints</span>
<span id="cb9-351"><a href="#cb9-351" aria-hidden="true" tabindex="-1"></a>              )), </span>
<span id="cb9-352"><a href="#cb9-352" aria-hidden="true" tabindex="-1"></a>            storageIndex</span>
<span id="cb9-353"><a href="#cb9-353" aria-hidden="true" tabindex="-1"></a>            ] <span class="ot">&lt;-</span> resSolve[<span class="dv">1</span>]</span>
<span id="cb9-354"><a href="#cb9-354" aria-hidden="true" tabindex="-1"></a>          relativeParetoWeightsBoundsArrayNew[<span class="dv">1</span>, stateIndex, storageIndex] <span class="ot">&lt;-</span> resSolve[<span class="dv">2</span>]</span>
<span id="cb9-355"><a href="#cb9-355" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb9-356"><a href="#cb9-356" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-357"><a href="#cb9-357" aria-hidden="true" tabindex="-1"></a>        <span class="co"># (iii) Calculate values in between</span></span>
<span id="cb9-358"><a href="#cb9-358" aria-hidden="true" tabindex="-1"></a>        relativeParetoWeightsLower <span class="ot">&lt;-</span> relativeParetoWeightsBoundsArrayNew[<span class="dv">1</span>, stateIndex, storageIndex]</span>
<span id="cb9-359"><a href="#cb9-359" aria-hidden="true" tabindex="-1"></a>        relativeParetoWeightsUpper <span class="ot">&lt;-</span> relativeParetoWeightsBoundsArrayNew[<span class="dv">2</span>, stateIndex, storageIndex]</span>
<span id="cb9-360"><a href="#cb9-360" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-361"><a href="#cb9-361" aria-hidden="true" tabindex="-1"></a>        relativeParetoWeightsLowerIndex <span class="ot">&lt;-</span> <span class="fu">which.min</span>(</span>
<span id="cb9-362"><a href="#cb9-362" aria-hidden="true" tabindex="-1"></a>          <span class="fu">abs</span>(relativeParetoWeightsGridPoints <span class="sc">-</span> relativeParetoWeightsLower)</span>
<span id="cb9-363"><a href="#cb9-363" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb9-364"><a href="#cb9-364" aria-hidden="true" tabindex="-1"></a>        relativeParetoWeightsUpperIndex <span class="ot">&lt;-</span> <span class="fu">which.min</span>(</span>
<span id="cb9-365"><a href="#cb9-365" aria-hidden="true" tabindex="-1"></a>          <span class="fu">abs</span>(relativeParetoWeightsGridPoints <span class="sc">-</span> relativeParetoWeightsUpper)</span>
<span id="cb9-366"><a href="#cb9-366" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb9-367"><a href="#cb9-367" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-368"><a href="#cb9-368" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (weightIndex <span class="cf">in</span> <span class="fu">seq</span>(relativeParetoWeightsLowerIndex, relativeParetoWeightsUpperIndex)) {</span>
<span id="cb9-369"><a href="#cb9-369" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb9-370"><a href="#cb9-370" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (</span>
<span id="cb9-371"><a href="#cb9-371" aria-hidden="true" tabindex="-1"></a>           <span class="fu">calculateEulerEquationDiff</span>(</span>
<span id="cb9-372"><a href="#cb9-372" aria-hidden="true" tabindex="-1"></a>              aggregateIncomeGridPoints[stateIndex],</span>
<span id="cb9-373"><a href="#cb9-373" aria-hidden="true" tabindex="-1"></a>              storageGridPoints[storageIndex],</span>
<span id="cb9-374"><a href="#cb9-374" aria-hidden="true" tabindex="-1"></a>              relativeParetoWeightsGridPoints[weightIndex],</span>
<span id="cb9-375"><a href="#cb9-375" aria-hidden="true" tabindex="-1"></a>              returnOnStorage,</span>
<span id="cb9-376"><a href="#cb9-376" aria-hidden="true" tabindex="-1"></a>              <span class="at">nextPeriodStorage =</span> <span class="dv">0</span>,</span>
<span id="cb9-377"><a href="#cb9-377" aria-hidden="true" tabindex="-1"></a>              aggregateIncomeGridPoints,</span>
<span id="cb9-378"><a href="#cb9-378" aria-hidden="true" tabindex="-1"></a>              relativeParetoWeightsGridPoints,</span>
<span id="cb9-379"><a href="#cb9-379" aria-hidden="true" tabindex="-1"></a>              nextStorageArray,</span>
<span id="cb9-380"><a href="#cb9-380" aria-hidden="true" tabindex="-1"></a>              relativeParetoWeightsBoundsArray,</span>
<span id="cb9-381"><a href="#cb9-381" aria-hidden="true" tabindex="-1"></a>              incomeTransitionMatrix[stateIndex,],</span>
<span id="cb9-382"><a href="#cb9-382" aria-hidden="true" tabindex="-1"></a>              storageGridPoints,</span>
<span id="cb9-383"><a href="#cb9-383" aria-hidden="true" tabindex="-1"></a>              numStates,</span>
<span id="cb9-384"><a href="#cb9-384" aria-hidden="true" tabindex="-1"></a>              sigma,</span>
<span id="cb9-385"><a href="#cb9-385" aria-hidden="true" tabindex="-1"></a>              beta</span>
<span id="cb9-386"><a href="#cb9-386" aria-hidden="true" tabindex="-1"></a>          ) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb9-387"><a href="#cb9-387" aria-hidden="true" tabindex="-1"></a>            nextStorageArrayNew[stateIndex, weightIndex, storageIndex] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb9-388"><a href="#cb9-388" aria-hidden="true" tabindex="-1"></a>            valueArrayHH1New[stateIndex, weightIndex, storageIndex] <span class="ot">&lt;-</span> <span class="fu">calculateValue</span>(</span>
<span id="cb9-389"><a href="#cb9-389" aria-hidden="true" tabindex="-1"></a>              aggregateIncomeGridPoints[stateIndex],</span>
<span id="cb9-390"><a href="#cb9-390" aria-hidden="true" tabindex="-1"></a>              storageGridPoints[storageIndex],</span>
<span id="cb9-391"><a href="#cb9-391" aria-hidden="true" tabindex="-1"></a>              <span class="at">currentRelativeParetoWeight =</span> relativeParetoWeightsGridPoints[weightIndex],</span>
<span id="cb9-392"><a href="#cb9-392" aria-hidden="true" tabindex="-1"></a>              returnOnStorage,</span>
<span id="cb9-393"><a href="#cb9-393" aria-hidden="true" tabindex="-1"></a>              <span class="at">nextPeriodStorage =</span> <span class="dv">0</span>,</span>
<span id="cb9-394"><a href="#cb9-394" aria-hidden="true" tabindex="-1"></a>              relativeParetoWeightsGridPoints,</span>
<span id="cb9-395"><a href="#cb9-395" aria-hidden="true" tabindex="-1"></a>              valueArrayHH1,</span>
<span id="cb9-396"><a href="#cb9-396" aria-hidden="true" tabindex="-1"></a>              incomeTransitionProbVec,</span>
<span id="cb9-397"><a href="#cb9-397" aria-hidden="true" tabindex="-1"></a>              storageGridPoints,</span>
<span id="cb9-398"><a href="#cb9-398" aria-hidden="true" tabindex="-1"></a>              numStates,</span>
<span id="cb9-399"><a href="#cb9-399" aria-hidden="true" tabindex="-1"></a>              sigma,</span>
<span id="cb9-400"><a href="#cb9-400" aria-hidden="true" tabindex="-1"></a>              beta,</span>
<span id="cb9-401"><a href="#cb9-401" aria-hidden="true" tabindex="-1"></a>              calculateHH1Consumption</span>
<span id="cb9-402"><a href="#cb9-402" aria-hidden="true" tabindex="-1"></a>              )</span>
<span id="cb9-403"><a href="#cb9-403" aria-hidden="true" tabindex="-1"></a>            valueArrayHH2New[stateIndex, weightIndex, storageIndex] <span class="ot">&lt;-</span> <span class="fu">calculateValue</span>(</span>
<span id="cb9-404"><a href="#cb9-404" aria-hidden="true" tabindex="-1"></a>              aggregateIncomeGridPoints[stateIndex],</span>
<span id="cb9-405"><a href="#cb9-405" aria-hidden="true" tabindex="-1"></a>              storageGridPoints[storageIndex],</span>
<span id="cb9-406"><a href="#cb9-406" aria-hidden="true" tabindex="-1"></a>              <span class="at">currentRelativeParetoWeight =</span> relativeParetoWeightsGridPoints[weightIndex],</span>
<span id="cb9-407"><a href="#cb9-407" aria-hidden="true" tabindex="-1"></a>              returnOnStorage,</span>
<span id="cb9-408"><a href="#cb9-408" aria-hidden="true" tabindex="-1"></a>              <span class="at">nextPeriodStorage =</span> <span class="dv">0</span>,</span>
<span id="cb9-409"><a href="#cb9-409" aria-hidden="true" tabindex="-1"></a>              relativeParetoWeightsGridPoints,</span>
<span id="cb9-410"><a href="#cb9-410" aria-hidden="true" tabindex="-1"></a>              valueArrayHH2,</span>
<span id="cb9-411"><a href="#cb9-411" aria-hidden="true" tabindex="-1"></a>              incomeTransitionProbVec,</span>
<span id="cb9-412"><a href="#cb9-412" aria-hidden="true" tabindex="-1"></a>              storageGridPoints,</span>
<span id="cb9-413"><a href="#cb9-413" aria-hidden="true" tabindex="-1"></a>              numStates,</span>
<span id="cb9-414"><a href="#cb9-414" aria-hidden="true" tabindex="-1"></a>              sigma,</span>
<span id="cb9-415"><a href="#cb9-415" aria-hidden="true" tabindex="-1"></a>              beta,</span>
<span id="cb9-416"><a href="#cb9-416" aria-hidden="true" tabindex="-1"></a>              calculateHH2Consumption</span>
<span id="cb9-417"><a href="#cb9-417" aria-hidden="true" tabindex="-1"></a>              )</span>
<span id="cb9-418"><a href="#cb9-418" aria-hidden="true" tabindex="-1"></a>          } <span class="cf">else</span> {</span>
<span id="cb9-419"><a href="#cb9-419" aria-hidden="true" tabindex="-1"></a>            nextStorageArrayNew[stateIndex, weightIndex, storageIndex] <span class="ot">&lt;-</span> <span class="fu">uniroot</span>(</span>
<span id="cb9-420"><a href="#cb9-420" aria-hidden="true" tabindex="-1"></a>              <span class="cf">function</span>(x) {<span class="fu">calculateEulerEquationDiff</span>(</span>
<span id="cb9-421"><a href="#cb9-421" aria-hidden="true" tabindex="-1"></a>                aggregateIncomeGridPoints[stateIndex],</span>
<span id="cb9-422"><a href="#cb9-422" aria-hidden="true" tabindex="-1"></a>                storageGridPoints[storageIndex],</span>
<span id="cb9-423"><a href="#cb9-423" aria-hidden="true" tabindex="-1"></a>                relativeParetoWeightsGridPoints[weightIndex],</span>
<span id="cb9-424"><a href="#cb9-424" aria-hidden="true" tabindex="-1"></a>                returnOnStorage,</span>
<span id="cb9-425"><a href="#cb9-425" aria-hidden="true" tabindex="-1"></a>                x,</span>
<span id="cb9-426"><a href="#cb9-426" aria-hidden="true" tabindex="-1"></a>                aggregateIncomeGridPoints,</span>
<span id="cb9-427"><a href="#cb9-427" aria-hidden="true" tabindex="-1"></a>                relativeParetoWeightsGridPoints,</span>
<span id="cb9-428"><a href="#cb9-428" aria-hidden="true" tabindex="-1"></a>                nextStorageArray,</span>
<span id="cb9-429"><a href="#cb9-429" aria-hidden="true" tabindex="-1"></a>                relativeParetoWeightsBoundsArray,</span>
<span id="cb9-430"><a href="#cb9-430" aria-hidden="true" tabindex="-1"></a>                incomeTransitionMatrix[stateIndex,],</span>
<span id="cb9-431"><a href="#cb9-431" aria-hidden="true" tabindex="-1"></a>                storageGridPoints,</span>
<span id="cb9-432"><a href="#cb9-432" aria-hidden="true" tabindex="-1"></a>                numStates,</span>
<span id="cb9-433"><a href="#cb9-433" aria-hidden="true" tabindex="-1"></a>                sigma,</span>
<span id="cb9-434"><a href="#cb9-434" aria-hidden="true" tabindex="-1"></a>                beta</span>
<span id="cb9-435"><a href="#cb9-435" aria-hidden="true" tabindex="-1"></a>                )},</span>
<span id="cb9-436"><a href="#cb9-436" aria-hidden="true" tabindex="-1"></a>              <span class="fu">c</span>(</span>
<span id="cb9-437"><a href="#cb9-437" aria-hidden="true" tabindex="-1"></a>                <span class="dv">0</span>, </span>
<span id="cb9-438"><a href="#cb9-438" aria-hidden="true" tabindex="-1"></a>                aggregateIncomeGridPoints[stateIndex] </span>
<span id="cb9-439"><a href="#cb9-439" aria-hidden="true" tabindex="-1"></a>                <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">+</span> returnOnStorage) <span class="sc">*</span> storageGridPoints[storageIndex] </span>
<span id="cb9-440"><a href="#cb9-440" aria-hidden="true" tabindex="-1"></a>                <span class="sc">-</span> <span class="fl">1e-12</span></span>
<span id="cb9-441"><a href="#cb9-441" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb9-442"><a href="#cb9-442" aria-hidden="true" tabindex="-1"></a>              )<span class="sc">$</span>root</span>
<span id="cb9-443"><a href="#cb9-443" aria-hidden="true" tabindex="-1"></a>            valueArrayHH1New[stateIndex, weightIndex, storageIndex] <span class="ot">&lt;-</span> <span class="fu">calculateValue</span>(</span>
<span id="cb9-444"><a href="#cb9-444" aria-hidden="true" tabindex="-1"></a>              aggregateIncomeGridPoints[stateIndex],</span>
<span id="cb9-445"><a href="#cb9-445" aria-hidden="true" tabindex="-1"></a>              storageGridPoints[storageIndex],</span>
<span id="cb9-446"><a href="#cb9-446" aria-hidden="true" tabindex="-1"></a>              <span class="at">currentRelativeParetoWeight =</span> relativeParetoWeightsGridPoints[weightIndex],</span>
<span id="cb9-447"><a href="#cb9-447" aria-hidden="true" tabindex="-1"></a>              returnOnStorage,</span>
<span id="cb9-448"><a href="#cb9-448" aria-hidden="true" tabindex="-1"></a>              <span class="at">nextPeriodStorage =</span> nextStorageArrayNew[stateIndex, weightIndex, storageIndex],</span>
<span id="cb9-449"><a href="#cb9-449" aria-hidden="true" tabindex="-1"></a>              relativeParetoWeightsGridPoints,</span>
<span id="cb9-450"><a href="#cb9-450" aria-hidden="true" tabindex="-1"></a>              valueArrayHH1,</span>
<span id="cb9-451"><a href="#cb9-451" aria-hidden="true" tabindex="-1"></a>              incomeTransitionProbVec,</span>
<span id="cb9-452"><a href="#cb9-452" aria-hidden="true" tabindex="-1"></a>              storageGridPoints,</span>
<span id="cb9-453"><a href="#cb9-453" aria-hidden="true" tabindex="-1"></a>              numStates,</span>
<span id="cb9-454"><a href="#cb9-454" aria-hidden="true" tabindex="-1"></a>              sigma,</span>
<span id="cb9-455"><a href="#cb9-455" aria-hidden="true" tabindex="-1"></a>              beta,</span>
<span id="cb9-456"><a href="#cb9-456" aria-hidden="true" tabindex="-1"></a>              calculateHH1Consumption</span>
<span id="cb9-457"><a href="#cb9-457" aria-hidden="true" tabindex="-1"></a>              )</span>
<span id="cb9-458"><a href="#cb9-458" aria-hidden="true" tabindex="-1"></a>            valueArrayHH2New[stateIndex, weightIndex, storageIndex] <span class="ot">&lt;-</span> <span class="fu">calculateValue</span>(</span>
<span id="cb9-459"><a href="#cb9-459" aria-hidden="true" tabindex="-1"></a>              aggregateIncomeGridPoints[stateIndex],</span>
<span id="cb9-460"><a href="#cb9-460" aria-hidden="true" tabindex="-1"></a>              storageGridPoints[storageIndex],</span>
<span id="cb9-461"><a href="#cb9-461" aria-hidden="true" tabindex="-1"></a>              <span class="at">currentRelativeParetoWeight =</span> relativeParetoWeightsGridPoints[weightIndex],</span>
<span id="cb9-462"><a href="#cb9-462" aria-hidden="true" tabindex="-1"></a>              returnOnStorage,</span>
<span id="cb9-463"><a href="#cb9-463" aria-hidden="true" tabindex="-1"></a>              <span class="at">nextPeriodStorage =</span> nextStorageArrayNew[stateIndex, weightIndex, storageIndex],</span>
<span id="cb9-464"><a href="#cb9-464" aria-hidden="true" tabindex="-1"></a>              relativeParetoWeightsGridPoints,</span>
<span id="cb9-465"><a href="#cb9-465" aria-hidden="true" tabindex="-1"></a>              valueArrayHH2,</span>
<span id="cb9-466"><a href="#cb9-466" aria-hidden="true" tabindex="-1"></a>              incomeTransitionProbVec,</span>
<span id="cb9-467"><a href="#cb9-467" aria-hidden="true" tabindex="-1"></a>              storageGridPoints,</span>
<span id="cb9-468"><a href="#cb9-468" aria-hidden="true" tabindex="-1"></a>              numStates,</span>
<span id="cb9-469"><a href="#cb9-469" aria-hidden="true" tabindex="-1"></a>              sigma,</span>
<span id="cb9-470"><a href="#cb9-470" aria-hidden="true" tabindex="-1"></a>              beta,</span>
<span id="cb9-471"><a href="#cb9-471" aria-hidden="true" tabindex="-1"></a>              calculateHH2Consumption</span>
<span id="cb9-472"><a href="#cb9-472" aria-hidden="true" tabindex="-1"></a>              )</span>
<span id="cb9-473"><a href="#cb9-473" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb9-474"><a href="#cb9-474" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb9-475"><a href="#cb9-475" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb9-476"><a href="#cb9-476" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Values and policies outside the interval</span></span>
<span id="cb9-477"><a href="#cb9-477" aria-hidden="true" tabindex="-1"></a>        nextStorageArrayNew[</span>
<span id="cb9-478"><a href="#cb9-478" aria-hidden="true" tabindex="-1"></a>          stateIndex,</span>
<span id="cb9-479"><a href="#cb9-479" aria-hidden="true" tabindex="-1"></a>          relativeParetoWeightsGridPoints <span class="sc">&gt;</span> relativeParetoWeightsUpper,</span>
<span id="cb9-480"><a href="#cb9-480" aria-hidden="true" tabindex="-1"></a>          storageIndex</span>
<span id="cb9-481"><a href="#cb9-481" aria-hidden="true" tabindex="-1"></a>        ] <span class="ot">&lt;-</span> nextStorageArrayNew[</span>
<span id="cb9-482"><a href="#cb9-482" aria-hidden="true" tabindex="-1"></a>          stateIndex,</span>
<span id="cb9-483"><a href="#cb9-483" aria-hidden="true" tabindex="-1"></a>          relativeParetoWeightsUpperIndex,</span>
<span id="cb9-484"><a href="#cb9-484" aria-hidden="true" tabindex="-1"></a>          storageIndex</span>
<span id="cb9-485"><a href="#cb9-485" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb9-486"><a href="#cb9-486" aria-hidden="true" tabindex="-1"></a>        valueArrayHH1New[</span>
<span id="cb9-487"><a href="#cb9-487" aria-hidden="true" tabindex="-1"></a>          stateIndex,</span>
<span id="cb9-488"><a href="#cb9-488" aria-hidden="true" tabindex="-1"></a>          relativeParetoWeightsGridPoints <span class="sc">&gt;</span> relativeParetoWeightsUpper,</span>
<span id="cb9-489"><a href="#cb9-489" aria-hidden="true" tabindex="-1"></a>          storageIndex</span>
<span id="cb9-490"><a href="#cb9-490" aria-hidden="true" tabindex="-1"></a>        ] <span class="ot">&lt;-</span> valueArrayHH1New[</span>
<span id="cb9-491"><a href="#cb9-491" aria-hidden="true" tabindex="-1"></a>          stateIndex,</span>
<span id="cb9-492"><a href="#cb9-492" aria-hidden="true" tabindex="-1"></a>          relativeParetoWeightsUpperIndex,</span>
<span id="cb9-493"><a href="#cb9-493" aria-hidden="true" tabindex="-1"></a>          storageIndex</span>
<span id="cb9-494"><a href="#cb9-494" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb9-495"><a href="#cb9-495" aria-hidden="true" tabindex="-1"></a>        valueArrayHH2New[</span>
<span id="cb9-496"><a href="#cb9-496" aria-hidden="true" tabindex="-1"></a>          stateIndex,</span>
<span id="cb9-497"><a href="#cb9-497" aria-hidden="true" tabindex="-1"></a>          relativeParetoWeightsGridPoints <span class="sc">&gt;</span> relativeParetoWeightsUpper,</span>
<span id="cb9-498"><a href="#cb9-498" aria-hidden="true" tabindex="-1"></a>          storageIndex</span>
<span id="cb9-499"><a href="#cb9-499" aria-hidden="true" tabindex="-1"></a>        ] <span class="ot">&lt;-</span> valueArrayHH2New[</span>
<span id="cb9-500"><a href="#cb9-500" aria-hidden="true" tabindex="-1"></a>          stateIndex,</span>
<span id="cb9-501"><a href="#cb9-501" aria-hidden="true" tabindex="-1"></a>          relativeParetoWeightsUpperIndex,</span>
<span id="cb9-502"><a href="#cb9-502" aria-hidden="true" tabindex="-1"></a>          storageIndex</span>
<span id="cb9-503"><a href="#cb9-503" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb9-504"><a href="#cb9-504" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-505"><a href="#cb9-505" aria-hidden="true" tabindex="-1"></a>        nextStorageArrayNew[</span>
<span id="cb9-506"><a href="#cb9-506" aria-hidden="true" tabindex="-1"></a>          stateIndex,</span>
<span id="cb9-507"><a href="#cb9-507" aria-hidden="true" tabindex="-1"></a>          relativeParetoWeightsGridPoints <span class="sc">&lt;</span> relativeParetoWeightsLower,</span>
<span id="cb9-508"><a href="#cb9-508" aria-hidden="true" tabindex="-1"></a>          storageIndex</span>
<span id="cb9-509"><a href="#cb9-509" aria-hidden="true" tabindex="-1"></a>        ] <span class="ot">&lt;-</span> nextStorageArrayNew[</span>
<span id="cb9-510"><a href="#cb9-510" aria-hidden="true" tabindex="-1"></a>          stateIndex,</span>
<span id="cb9-511"><a href="#cb9-511" aria-hidden="true" tabindex="-1"></a>          relativeParetoWeightsLowerIndex,</span>
<span id="cb9-512"><a href="#cb9-512" aria-hidden="true" tabindex="-1"></a>          storageIndex</span>
<span id="cb9-513"><a href="#cb9-513" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb9-514"><a href="#cb9-514" aria-hidden="true" tabindex="-1"></a>        valueArrayHH1New[</span>
<span id="cb9-515"><a href="#cb9-515" aria-hidden="true" tabindex="-1"></a>          stateIndex,</span>
<span id="cb9-516"><a href="#cb9-516" aria-hidden="true" tabindex="-1"></a>          relativeParetoWeightsGridPoints <span class="sc">&lt;</span> relativeParetoWeightsLower,</span>
<span id="cb9-517"><a href="#cb9-517" aria-hidden="true" tabindex="-1"></a>          storageIndex</span>
<span id="cb9-518"><a href="#cb9-518" aria-hidden="true" tabindex="-1"></a>        ] <span class="ot">&lt;-</span> valueArrayHH1New[</span>
<span id="cb9-519"><a href="#cb9-519" aria-hidden="true" tabindex="-1"></a>          stateIndex,</span>
<span id="cb9-520"><a href="#cb9-520" aria-hidden="true" tabindex="-1"></a>          relativeParetoWeightsLowerIndex,</span>
<span id="cb9-521"><a href="#cb9-521" aria-hidden="true" tabindex="-1"></a>          storageIndex</span>
<span id="cb9-522"><a href="#cb9-522" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb9-523"><a href="#cb9-523" aria-hidden="true" tabindex="-1"></a>        valueArrayHH2New[</span>
<span id="cb9-524"><a href="#cb9-524" aria-hidden="true" tabindex="-1"></a>          stateIndex,</span>
<span id="cb9-525"><a href="#cb9-525" aria-hidden="true" tabindex="-1"></a>          relativeParetoWeightsGridPoints <span class="sc">&lt;</span> relativeParetoWeightsLower,</span>
<span id="cb9-526"><a href="#cb9-526" aria-hidden="true" tabindex="-1"></a>          storageIndex</span>
<span id="cb9-527"><a href="#cb9-527" aria-hidden="true" tabindex="-1"></a>        ] <span class="ot">&lt;-</span> valueArrayHH2New[</span>
<span id="cb9-528"><a href="#cb9-528" aria-hidden="true" tabindex="-1"></a>          stateIndex,</span>
<span id="cb9-529"><a href="#cb9-529" aria-hidden="true" tabindex="-1"></a>          relativeParetoWeightsLowerIndex,</span>
<span id="cb9-530"><a href="#cb9-530" aria-hidden="true" tabindex="-1"></a>          storageIndex</span>
<span id="cb9-531"><a href="#cb9-531" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb9-532"><a href="#cb9-532" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb9-533"><a href="#cb9-533" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb9-534"><a href="#cb9-534" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb9-535"><a href="#cb9-535" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-536"><a href="#cb9-536" aria-hidden="true" tabindex="-1"></a>    diff <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="fu">c</span>(</span>
<span id="cb9-537"><a href="#cb9-537" aria-hidden="true" tabindex="-1"></a>      <span class="fu">max</span>(<span class="fu">abs</span>(valueArrayHH1New <span class="sc">-</span> valueArrayHH1)),</span>
<span id="cb9-538"><a href="#cb9-538" aria-hidden="true" tabindex="-1"></a>      <span class="fu">max</span>(<span class="fu">abs</span>(valueArrayHH2New <span class="sc">-</span> valueArrayHH2))</span>
<span id="cb9-539"><a href="#cb9-539" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb9-540"><a href="#cb9-540" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-541"><a href="#cb9-541" aria-hidden="true" tabindex="-1"></a>    relativeParetoWeightsBoundsArray <span class="ot">&lt;-</span> relativeParetoWeightsBoundsArrayNew</span>
<span id="cb9-542"><a href="#cb9-542" aria-hidden="true" tabindex="-1"></a>    nextStorageArray <span class="ot">&lt;-</span> nextStorageArrayNew</span>
<span id="cb9-543"><a href="#cb9-543" aria-hidden="true" tabindex="-1"></a>    valueArrayHH1 <span class="ot">&lt;-</span> valueArrayHH1New</span>
<span id="cb9-544"><a href="#cb9-544" aria-hidden="true" tabindex="-1"></a>    valueArrayHH2 <span class="ot">&lt;-</span> valueArrayHH2New</span>
<span id="cb9-545"><a href="#cb9-545" aria-hidden="true" tabindex="-1"></a>    iter <span class="ot">&lt;-</span> iter <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb9-546"><a href="#cb9-546" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-547"><a href="#cb9-547" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb9-548"><a href="#cb9-548" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-549"><a href="#cb9-549" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(</span>
<span id="cb9-550"><a href="#cb9-550" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(</span>
<span id="cb9-551"><a href="#cb9-551" aria-hidden="true" tabindex="-1"></a>      <span class="at">valueArrayHH1 =</span> valueArrayHH1,</span>
<span id="cb9-552"><a href="#cb9-552" aria-hidden="true" tabindex="-1"></a>      <span class="at">valueArrayHH2 =</span> valueArrayHH2,</span>
<span id="cb9-553"><a href="#cb9-553" aria-hidden="true" tabindex="-1"></a>      <span class="at">nextStorageArray =</span> nextStorageArray,</span>
<span id="cb9-554"><a href="#cb9-554" aria-hidden="true" tabindex="-1"></a>      <span class="at">relativeParetoWeightsBoundsArray =</span> relativeParetoWeightsBoundsArray</span>
<span id="cb9-555"><a href="#cb9-555" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-556"><a href="#cb9-556" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb9-557"><a href="#cb9-557" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>LCWithStorageResult <span class="ot">&lt;-</span> <span class="fu">solveLCWithStorage</span>(</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    beta,</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    sigma,</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    returnOnStorage,</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    numStates,</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    incomeGridPointsHH1,</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    incomeGridPointsHH2,</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    aggregateIncomeGridPoints,</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    incomeTransitionProbVec,</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    incomeTransitionMatrix</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  LCWithStorageResult,</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">file.path</span>(<span class="st">'IntermediateData/modelSolution.rds'</span>)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


<div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography">
<div id="ref-abraham2018efficient" class="csl-entry" role="doc-biblioentry">
Ábrahám, Árpád, and Sarolta Laczó. 2018. <span>“Efficient Risk Sharing with Limited Commitment and Storage.”</span> <em>The Review of Economic Studies</em> 85 (3): 1389–1424.
</div>
</div>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./lc_storage_model.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Risk sharing with limited commitment and storage: Model</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./lc_storage_simulation.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Risk sharing with limited commitment and storage: Simulation</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>